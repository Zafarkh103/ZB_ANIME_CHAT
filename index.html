<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"> 
  <title>ZB WhatsApp Pro</title>
  <style>
    /* EXISTING ALL STYLES RAKHA HAI */
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f0f2f5;
      display: flex;
      flex-direction: column;
      min-height: 100vh; 
    }
    .chat-container {
      flex-grow: 1;
      padding: 10px;
      overflow-y: auto;
      background-color: #e5ddd5; 
      background-image: url('box Wallpaper.png'); 
      background-size: cover;
      background-position: center;
      background-color: #e5ddd5; 
      display: flex;
      flex-direction: column;
      padding-top: 50px; 
      padding-bottom: 120px;
    }
    .chat-header {
      position: fixed;
      top: 0;
      width: 100%;
      background-color: #075e54; 
      color: white;
      padding: 6px 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
      z-index: 10;
      display: flex;
      align-items: center;
      justify-content: space-between;
      height: 40px;
      box-sizing: border-box;
    }
    .header-left {
      display: flex;
      align-items: center;
      font-size: 16px;
    }
    .status-dot {
      height: 8px;
      width: 8px;
      background-color: gray;
      border-radius: 50%;
      display: inline-block;
      margin-left: 6px;
    }
    .online {
      background-color: #25d366;
    }
    .message {
      margin-bottom: 8px;
      padding: 10px 14px;
      border-radius: 8px;
      max-width: 80%;
      word-wrap: break-word;
      line-height: 1.5;
      position: relative;
      font-size: 18px;
      box-shadow: 0 1px 0.5px rgba(0, 0, 0, 0.13);
    }
    .sent {
      background-color: #dcf8c6;
      align-self: flex-end;
      margin-left: auto;
    }
    .received {
      background-color: #ffffff;
      align-self: flex-start;
      margin-right: auto;
    }
    .sender-name {
      font-size: 14px;
      color: #777;
      margin-bottom: 2px;
      display: block;
      font-weight: bold;
    }
    .timestamp-tick {
      font-size: 12px;
      color: #929292;
      float: right;
      margin-left: 8px;
      line-height: 1.5;
    }
    .double-tick {
      color: #53bdeb;
    }
    .context-menu {
      position: fixed;
      background: white;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-shadow: 2px 2px 5px rgba(0,0,0,0.3);
      z-index: 20;
      display: none;
    }
    .context-menu-item {
      padding: 10px 20px;
      cursor: pointer;
      font-size: 16px;
    }
    .context-menu-item:hover {
      background-color: #f0f0f0;
    }
    .delete-option {
      color: #c0392b;
    }
    .edit-option {
      color: #2980b9;
    }
    .reply-option {
      color: #27ae60;
    }
    .forward-option {
      color: #f39c12;
    }
    .input-area {
      display: flex;
      padding: 10px;
      background-color: #f6f6f6;
      position: fixed;
      bottom: 50px;
      width: 100%;
      box-sizing: border-box;
      align-items: center;
      border-top: 1px solid #ddd;
      gap: 8px;
    }
    .input-left {
      display: flex;
      align-items: center;
      gap: 5px;
      flex-shrink: 0;
    }
    .input-right {
      display: flex;
      align-items: center;
      gap: 5px;
      flex-shrink: 0;
    }
    #messageInput {
      flex: 1;
      min-width: 0;
      padding: 12px 16px;
      border-radius: 20px;
      border: none;
      font-size: 16px;
      background-color: white;
      outline: none;
    }
    .icon-button {
      width: 40px;
      height: 40px;
      border: none;
      border-radius: 50%;
      background: none;
      font-size: 20px;
      cursor: pointer;
      display: flex;
      justify-content: center;
      align-items: center;
      color: #54656f;
    }
    .icon-button:hover {
      background-color: #e0e0e0;
    }
    #sendButton {
      width: 45px;
      height: 45px;
      border: none;
      border-radius: 50%;
      background-color: #128c7e !important;
      color: white !important;
      cursor: pointer;
      font-size: 18px;
      display: flex !important;
      justify-content: center;
      align-items: center;
      flex-shrink: 0;
      visibility: visible !important;
      opacity: 1 !important;
    }
    #sendButton:hover {
      background-color: #075e54 !important;
    }
    .emoji-picker {
      position: fixed;
      bottom: 120px;
      right: 10px;
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      padding: 10px;
      display: none;
      z-index: 30;
      max-height: 200px;
      overflow-y: auto;
      width: 250px;
    }
    .emoji {
      font-size: 20px;
      padding: 5px;
      cursor: pointer;
      display: inline-block;
    }
    .emoji:hover {
      background-color: #f0f0f0;
      border-radius: 5px;
    }
    .typing-indicator {
      font-size: 12px;
      color: #999;
      padding: 5px 15px;
      font-style: italic;
      display: none;
    }
    .reply-preview {
      background: #f0f0f0;
      border-left: 4px solid #128c7e;
      padding: 8px 12px;
      margin-bottom: 8px;
      border-radius: 5px;
      font-size: 14px;
      display: none;
      position: relative;
    }
    .reply-sender {
      font-weight: bold;
      color: #128c7e;
    }
    .cancel-reply {
      position: absolute;
      right: 10px;
      top: 8px;
      cursor: pointer;
      color: #999;
      font-size: 16px;
    }
    .theme-toggle {
      background: none;
      border: none;
      color: white;
      font-size: 18px;
      cursor: pointer;
      margin-left: 15px;
    }
    .dark-theme {
      background-color: #0d1418;
      color: white;
    }
    .dark-theme .chat-container {
      background-color: #0d1418;
    }
    .dark-theme .message.received {
      background-color: #2a2f32;
      color: white;
    }
    .dark-theme .input-area {
      background-color: #1e2a30;
    }
    .dark-theme #messageInput {
      background-color: #2a3942;
      color: white;
    }
    .loading {
      text-align: center;
      padding: 10px;
      color: #999;
    }
    .spinner {
      border: 2px solid #f3f3f3;
      border-top: 2px solid #128c7e;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
      display: inline-block;
      margin-right: 10px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .online-users {
      position: fixed;
      top: 50px;
      right: 10px;
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      padding: 10px;
      z-index: 5;
      display: none;
      max-width: 200px;
    }
    .user-item {
      padding: 8px;
      border-bottom: 1px solid #eee;
      display: flex;
      align-items: center;
    }
    .user-dot {
      width: 8px;
      height: 8px;
      background: #25d366;
      border-radius: 50%;
      margin-right: 8px;
    }
    #nameModal, #roomModal {
      display: none; 
      position: fixed;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      z-index: 100;
      justify-content: center;
      align-items: center;
    }
    .modal-content {
      background-color: #fff;
      padding: 30px;
      border-radius: 10px;
      text-align: center;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
      max-width: 300px;
      width: 90%;
      animation: fadeIn 0.3s ease-out;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    #nameInput, #roomPassword {
      width: 100%;
      padding: 10px;
      margin: 15px 0;
      border: 2px solid #ccc;
      border-radius: 6px;
      box-sizing: border-box;
      font-size: 16px;
    }
    #submitName, #submitRoom {
      background-color: #128c7e;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 20px;
      cursor: pointer;
      font-size: 16px;
      transition: background-color 0.3s;
    }
    #submitName:hover, #submitRoom:hover {
      background-color: #075e54;
    }
    .rooms-menu {
      position: fixed;
      top: 50px;
      right: 10px;
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      padding: 10px;
      z-index: 5;
      display: none;
      max-width: 200px;
    }
    .room-item {
      padding: 10px;
      border-bottom: 1px solid #eee;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .room-item:hover {
      background-color: #f0f0f0;
    }
    .room-lock {
      color: #999;
      font-size: 14px;
    }
    .room-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      background-color: #075e54;
      color: white;
      border-radius: 5px;
      margin-bottom: 10px;
    }
    .room-name {
      font-weight: bold;
    }
    .leave-room {
      background: none;
      border: none;
      color: white;
      cursor: pointer;
      font-size: 14px;
    }
    .file-message {
      background: #f8f9fa;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 10px;
      margin: 5px 0;
      max-width: 250px;
    }
    .file-icon {
      font-size: 24px;
      margin-right: 10px;
    }
    .file-info {
      display: flex;
      align-items: center;
    }
    .file-name {
      font-weight: bold;
      font-size: 14px;
      margin-bottom: 5px;
    }
    .file-size {
      font-size: 12px;
      color: #666;
    }
    .download-btn {
      background: #128c7e;
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      margin-top: 5px;
    }
    .image-message {
      max-width: 200px;
      border-radius: 8px;
      margin: 5px 0;
    }
    .voice-message {
      background: #dcf8c6;
      padding: 10px 15px;
      border-radius: 18px;
      display: flex;
      align-items: center;
      max-width: 200px;
    }
    .voice-play-btn {
      background: none;
      border: none;
      font-size: 20px;
      cursor: pointer;
      margin-right: 10px;
    }
    .voice-duration {
      font-size: 12px;
      color: #666;
    }
    .search-container {
      position: fixed;
      top: 50px;
      left: 0;
      width: 100%;
      background: white;
      padding: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      z-index: 5;
      display: none;
    }
    .search-input {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 20px;
      font-size: 14px;
    }
    .notification {
      position: fixed;
      top: 60px;
      right: 10px;
      background: #25d366;
      color: white;
      padding: 10px 15px;
      border-radius: 5px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      z-index: 1000;
      display: none;
    }
    .profile-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 100;
      justify-content: center;
      align-items: center;
    }
    .profile-content {
      background: white;
      padding: 20px;
      border-radius: 10px;
      max-width: 300px;
      width: 90%;
    }
    .reaction {
      font-size: 12px;
      background: white;
      border-radius: 10px;
      padding: 2px 6px;
      margin-left: 5px;
      border: 1px solid #ddd;
    }
    .reaction-picker {
      position: absolute;
      background: white;
      border-radius: 20px;
      padding: 5px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      display: none;
      z-index: 10;
    }
    .starred-icon {
      color: #ffd700;
      margin-left: 5px;
    }
    .settings-menu {
      position: fixed;
      top: 50px;
      right: 10px;
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      padding: 10px;
      z-index: 5;
      display: none;
      min-width: 150px;
    }
    .settings-item {
      padding: 10px;
      cursor: pointer;
      border-bottom: 1px solid #eee;
    }
    .settings-item:hover {
      background: #f0f0f0;
    }
    .group-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #128c7e;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      margin-right: 10px;
    }
    .blocked-message {
      font-style: italic;
      color: #999;
      text-align: center;
      padding: 10px;
    }

    /* NEW NAVIGATION BAR STYLES */
    .nav-bar {
      position: fixed;
      bottom: 0;
      width: 100%;
      background: #fff;
      display: flex;
      justify-content: space-around;
      padding: 8px 0;
      border-top: 1px solid #e0e0e0;
      z-index: 100;
    }
    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 5px 10px;
      cursor: pointer;
      color: #666;
      font-size: 12px;
      transition: all 0.3s;
      flex: 1;
      text-align: center;
    }
    .nav-item.active {
      color: #128c7e;
    }
    .nav-icon {
      font-size: 20px;
      margin-bottom: 2px;
    }
    .nav-label {
      font-size: 10px;
    }
  </style>
</head>
<body>
  
  <!-- Name Modal -->
  <div id="nameModal">
    <div class="modal-content">
      <h2>üõ°Ô∏èONLY CHAT NO SPAMüõ°Ô∏è</h2>
      <p>Enter Real Name ? (Enter your Real name to continue)</p>
      <input type="text" id="nameInput" placeholder="Enter Real Name likhein (e.g., Zafar/Zohaib)">
      <button id="submitName">Chat Shuru Karein</button>
    </div>
  </div>

  <!-- Room Password Modal -->
  <div id="roomModal">
    <div class="modal-content">
      <h2>Chat Room Access</h2>
      <p id="roomModalText">Enter password for Chatroom1</p>
      <input type="password" id="roomPassword" placeholder="Enter password">
      <button id="submitRoom">Join Room</button>
    </div>
  </div>

  <!-- NEW: Profile Modal -->
  <div id="profileModal" class="profile-modal">
    <div class="profile-content">
      <h3>User Profile</h3>
      <div id="profileInfo">
        <!-- Profile info will be loaded here -->
      </div>
      <button id="closeProfile">Close</button>
    </div>
  </div>

  <!-- NEW: Search Bar -->
  <div class="search-container" id="searchContainer">
    <input type="text" class="search-input" id="searchInput" placeholder="Search messages...">
    <button id="closeSearch">‚úï</button>
  </div>

  <!-- NEW: Notification -->
  <div class="notification" id="notification">
    New message received!
  </div>

  <!-- Chat Header with new features -->
  <div class="chat-header">
    <div class="header-left">
      <span id="currentRoomName">ZB WhatsApp Pro</span>
      <span id="otherUserStatus" class="status-dot"></span>
      <span id="statusText" style="font-size: 14px; margin-left: 5px;">Only For Messages</span>
    </div>
    <div>
      <button class="theme-toggle" id="themeToggle">üåô</button>
      <button class="icon-button" id="searchBtn">üîç</button>
      <button class="icon-button" id="attachBtn">üìé</button>
      <button class="icon-button" id="profileBtn">üë§</button>
      <button class="icon-button" id="settingsBtn">‚öôÔ∏è</button>
      <button class="icon-button" id="roomsBtn">‚ãÆ</button>
      <button class="icon-button" id="onlineUsersBtn">üë•</button>
    </div>
  </div>

  <!-- NEW: Settings Menu -->
  <div class="settings-menu" id="settingsMenu">
    <div class="settings-item" id="exportChats">Export Chats</div>
    <div class="settings-item" id="changeWallpaper">Change Wallpaper</div>
    <div class="settings-item" id="fontSize">Font Size</div>
    <div class="settings-item" id="notificationSettings">Notifications</div>
    <div class="settings-item" id="privacySettings">Privacy</div>
  </div>

  <!-- Chat Rooms Menu -->
  <div class="rooms-menu" id="roomsMenu">
    <h4>Chat Rooms</h4>
    <div class="room-item" data-room="general" data-password="">
      <span>General Chat</span>
      <span class="room-lock">üîì</span>
    </div>
    <div class="room-item" data-room="Chatroom1" data-password="ZAFAR1">
      <span>Chatroom 1</span>
      <span class="room-lock">üîí</span>
    </div>
    <div class="room-item" data-room="Chatroom2" data-password="ZAFAR2">
      <span>Chatroom 2</span>
      <span class="room-lock">üîí</span>
    </div>
    <div class="room-item" data-room="Chatroom3" data-password="ZAFAR3">
      <span>Chatroom 3</span>
      <span class="room-lock">üîí</span>
    </div>
    <div class="room-item" data-room="Chatroom4" data-password="ZAFAR4">
      <span>Chatroom 4</span>
      <span class="room-lock">üîí</span>
    </div>
    <div class="room-item" data-room="Chatroom5" data-password="ZAFAR5">
      <span>Chatroom 5</span>
      <span class="room-lock">üîí</span>
    </div>
  </div>

  <!-- Online Users List -->
  <div class="online-users" id="onlineUsers">
    <h4>Online Users</h4>
    <div id="usersList"></div>
  </div>

  <!-- Chat Container -->
  <div class="chat-container" id="messages">
    <div class="loading" id="loadingMessages">
      <div class="spinner"></div>Loading messages...
    </div>
  </div>

  <!-- Typing Indicator -->
  <div class="typing-indicator" id="typingIndicator">
    Someone is typing...
  </div>

  <!-- Reply Preview -->
  <div class="reply-preview" id="replyPreview">
    <span class="cancel-reply" id="cancelReply">‚úï</span>
    <div class="reply-sender" id="replySender"></div>
    <div id="replyText"></div>
  </div>

  <!-- SIMPLIFIED INPUT AREA -->
  <div class="input-area">
    <div class="input-left">
      <button class="icon-button" id="emojiBtn">üòä</button>
    </div>
    
    <input type="text" id="messageInput" placeholder="Type a message...">
    
    <div class="input-right">
      <button class="icon-button" id="voiceBtn">üé§</button>
      <input type="file" id="fileInput" style="display:none" accept="image/*,video/*,.pdf,.doc,.docx,.txt">
      <button id="sendButton">‚û§</button>
    </div>
  </div>

  <!-- NEW NAVIGATION BAR -->
  <div class="nav-bar">
    <div class="nav-item active" data-page="index.html">
      <div class="nav-icon">üí¨</div>
      <div class="nav-label">Chats</div>
    </div>
    <div class="nav-item" data-page="groups.html">
      <div class="nav-icon">üë•</div>
      <div class="nav-label">Groups</div>
    </div>
    <div class="nav-item" data-page="calls.html">
      <div class="nav-icon">üìû</div>
      <div class="nav-label">Calls</div>
    </div>
    <div class="nav-item" data-page="status.html">
      <div class="nav-icon">üì¢</div>
      <div class="nav-label">Status</div>
    </div>
    <div class="nav-item" data-page="settings.html">
      <div class="nav-icon">‚öôÔ∏è</div>
      <div class="nav-label">Settings</div>
    </div>
  </div>

  <!-- Emoji Picker -->
  <div class="emoji-picker" id="emojiPicker">
    <!-- Emojis will be added here by JavaScript -->
  </div>

  <!-- Context Menu - ALL OPTIONS KEPT -->
  <div id="contextMenu" class="context-menu">
    <div class="context-menu-item reply-option" id="replyOption">Reply</div>
    <div class="context-menu-item edit-option" id="editOption">Edit</div>
    <div class="context-menu-item forward-option" id="forwardOption">Forward</div>
    <div class="context-menu-item delete-option" id="deleteOption">Delete</div>
    <!-- NEW: Context menu additions -->
    <div class="context-menu-item" id="reactOption">React</div>
    <div class="context-menu-item" id="starOption">Star</div>
  </div>

  <!-- NEW: Reaction Picker -->
  <div class="reaction-picker" id="reactionPicker">
    <span class="emoji">üëç</span>
    <span class="emoji">‚ù§Ô∏è</span>
    <span class="emoji">üòÇ</span>
    <span class="emoji">üòÆ</span>
    <span class="emoji">üò¢</span>
    <span class="emoji">üëè</span>
  </div>

  <!-- Firebase Scripts -->
  <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>                                                             
  <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-storage.js"></script>

  <script>
    // ALL EXISTING JAVASCRIPT CODE RAKHA HAI
    const firebaseConfig = {
      apiKey: "AIzaSyB8zMhCjGxmHBpruABYA4pBj3jU0uMHCs0",
      authDomain: "zafi-chat-app.firebaseapp.com",
      projectId: "zafi-chat-app",
      storageBucket: "zafi-chat-app.firebasestorage.app",
      messagingSenderId: "989950346714",
      appId: "1:989950346714:web:7bad7f8fae2a72ce0bace3",
      measurementId: "G-XW5MS2D2K7",
      databaseURL: "https://zafi-chat-app-default-rtdb.asia-southeast1.firebasedatabase.app" 
    };
                     
    const app = firebase.initializeApp(firebaseConfig);
    const database = app.database();
    const auth = app.auth();
    const storage = app.storage();
                                                 
    let currentUserId = null;
    let currentUserName = null; 
    let otherUserId = null;
    let isDarkTheme = false;
    let replyToMessage = null;
    let editMessageKey = null;
    let typingTimer = null;
    let currentRoom = 'general';
    let mediaRecorder = null;
    let audioChunks = [];
    let isRecording = false;
    
    // DOM Elements
    const nameModal = document.getElementById('nameModal');
    const roomModal = document.getElementById('roomModal');
    const nameInput = document.getElementById('nameInput');
    const roomPassword = document.getElementById('roomPassword');
    const roomModalText = document.getElementById('roomModalText');
    const submitNameButton = document.getElementById('submitName');
    const submitRoomButton = document.getElementById('submitRoom');
    const messagesRef = database.ref('messages');
    const messagesDiv = document.getElementById('messages');
    const messageInput = document.getElementById('messageInput');
    const sendButton = document.getElementById('sendButton');
    const contextMenu = document.getElementById('contextMenu');
    const loadingMessages = document.getElementById('loadingMessages');
    const typingIndicator = document.getElementById('typingIndicator');
    const replyPreview = document.getElementById('replyPreview');
    const replySender = document.getElementById('replySender');
    const replyText = document.getElementById('replyText');
    const cancelReply = document.getElementById('cancelReply');
    const emojiPicker = document.getElementById('emojiPicker');
    const emojiBtn = document.getElementById('emojiBtn');
    const voiceBtn = document.getElementById('voiceBtn');
    const themeToggle = document.getElementById('themeToggle');
    const onlineUsersBtn = document.getElementById('onlineUsersBtn');
    const onlineUsers = document.getElementById('onlineUsers');
    const usersList = document.getElementById('usersList');
    const roomsBtn = document.getElementById('roomsBtn');
    const roomsMenu = document.getElementById('roomsMenu');
    const currentRoomName = document.getElementById('currentRoomName');
    const roomItems = document.querySelectorAll('.room-item');
    
    // NEW: Additional DOM Elements for new features
    const attachBtn = document.getElementById('attachBtn');
    const fileInput = document.getElementById('fileInput');
    const searchBtn = document.getElementById('searchBtn');
    const searchContainer = document.getElementById('searchContainer');
    const searchInput = document.getElementById('searchInput');
    const closeSearch = document.getElementById('closeSearch');
    const profileBtn = document.getElementById('profileBtn');
    const profileModal = document.getElementById('profileModal');
    const closeProfile = document.getElementById('closeProfile');
    const profileInfo = document.getElementById('profileInfo');
    const settingsBtn = document.getElementById('settingsBtn');
    const settingsMenu = document.getElementById('settingsMenu');
    const notification = document.getElementById('notification');
    const reactionPicker = document.getElementById('reactionPicker');

    // NEW: Navigation Elements
    const navItems = document.querySelectorAll('.nav-item');

    // Emoji Array
    const emojis = ['üòÄ', 'üòÉ', 'üòÑ', 'üòÅ', 'üòÜ', 'üòÖ', 'üòÇ', 'ü§£', 'üòä', 'üòá', 'üôÇ', 'üôÉ', 'üòâ', 'üòå', 'üòç', 'ü•∞', 'üòò', 'üòó', 'üòô', 'üòö', 'üòã', 'üòõ', 'üòù', 'üòú', 'ü§™', 'ü§®', 'üßê', 'ü§ì', 'üòé', 'ü§©', 'ü•≥', 'üòè', 'üòí', 'üòû', 'üòî', 'üòü', 'üòï', 'üôÅ', '‚òπÔ∏è', 'üò£', 'üòñ', 'üò´', 'üò©', 'ü•∫', 'üò¢', 'üò≠', 'üò§', 'üò†', 'üò°', 'ü§¨', 'ü§Ø', 'üò≥', 'ü•µ', 'ü•∂', 'üò±', 'üò®', 'üò∞', 'üò•', 'üòì', 'ü§ó', 'ü§î', 'ü§≠', 'ü§´', 'ü§•', 'üò∂', 'üòê', 'üòë', 'üò¨', 'üôÑ', 'üòØ', 'üò¶', 'üòß', 'üòÆ', 'üò≤', 'ü•±', 'üò¥', 'ü§§', 'üò™', 'üòµ', 'ü§ê', 'ü•¥', 'ü§¢', 'ü§Æ', 'ü§ß', 'üò∑', 'ü§í', 'ü§ï', 'ü§ë', 'ü§†', 'üòà', 'üëø', 'üëπ', 'üë∫', 'ü§°', 'üí©', 'üëª', 'üíÄ', '‚ò†Ô∏è', 'üëΩ', 'üëæ', 'ü§ñ', 'üéÉ', 'üò∫', 'üò∏', 'üòπ', 'üòª', 'üòº', 'üòΩ', 'üôÄ', 'üòø', 'üòæ'];

    // NEW: File type icons mapping
    const fileIcons = {
        'pdf': 'üìï',
        'doc': 'üìò',
        'docx': 'üìò',
        'txt': 'üìÑ',
        'zip': 'üì¶',
        'mp3': 'üéµ',
        'wav': 'üéµ',
        'default': 'üìé'
    };

    // NEW: Navigation Functionality
    function setupNavigation() {
        navItems.forEach(item => {
            item.addEventListener('click', function() {
                // Remove active class from all items
                navItems.forEach(nav => nav.classList.remove('active'));
                // Add active class to clicked item
                this.classList.add('active');
                
                const page = this.getAttribute('data-page');
                if (page !== 'index.html') {
                    window.location.href = page;
                }
            });
        });
    }

    // SIMPLE SEND MESSAGE FUNCTION - GUARANTEED TO WORK
    function sendMessage() {
        console.log("=== SEND MESSAGE FUNCTION CALLED ===");
        
        const messageText = messageInput.value.trim();
        console.log("Message text:", messageText);
        console.log("Current User ID:", currentUserId);
        console.log("Current User Name:", currentUserName);
        
        // Check if user is ready
        if (!currentUserId || !currentUserName) {
            console.log("User not ready - showing modal");
            nameModal.style.display = 'flex';
            nameInput.focus();
            return;
        }
        
        // Check if message is empty
        if (!messageText) {
            console.log("Message is empty - not sending");
            return;
        }
        
        console.log("All checks passed - sending to Firebase");
        
        // Send message to Firebase
        const roomRef = database.ref('rooms/' + currentRoom + '/messages');
        roomRef.push({
            text: messageText,
            senderId: currentUserId,
            senderName: currentUserName,
            timestamp: Date.now(),
            type: 'text',
            read: false
        }).then(() => {
            console.log("‚úÖ Message sent successfully to Firebase!");
            messageInput.value = ''; // Clear input
            messageInput.focus(); // Focus back to input
            
            // Hide reply preview if active
            if (replyPreview.style.display === 'block') {
                replyPreview.style.display = 'none';
                replyToMessage = null;
            }
            
        }).catch((error) => {
            console.error("‚ùå Error sending message:", error);
            alert("Message send nahi ho saka. Internet check karein.");
        });
    }

    // NEW: Send file message function
    function sendFileMessage(file, type) {
        if (!currentUserId || !currentUserName) {
            nameModal.style.display = 'flex';
            return;
        }

        const roomRef = database.ref('rooms/' + currentRoom + '/messages');
        const fileRef = storage.ref('chat_files/' + Date.now() + '_' + file.name);
        
        // Show uploading indicator
        showNotification('Uploading file...');
        
        fileRef.put(file).then((snapshot) => {
            return snapshot.ref.getDownloadURL();
        }).then((downloadURL) => {
            roomRef.push({
                type: type,
                fileUrl: downloadURL,
                fileName: file.name,
                fileSize: file.size,
                senderId: currentUserId,
                senderName: currentUserName,
                timestamp: Date.now(),
                read: false
            });
            showNotification('File sent successfully!');
        }).catch((error) => {
            console.error("File upload error:", error);
            showNotification('File upload failed!', true);
        });
    }

    // NEW: Send voice message function
    function sendVoiceMessage(audioBlob) {
        if (!currentUserId || !currentUserName) return;

        const roomRef = database.ref('rooms/' + currentRoom + '/messages');
        const voiceRef = storage.ref('voice_messages/' + Date.now() + '.wav');
        
        showNotification('Sending voice message...');
        
        voiceRef.put(audioBlob).then((snapshot) => {
            return snapshot.ref.getDownloadURL();
        }).then((downloadURL) => {
            roomRef.push({
                type: 'voice',
                voiceUrl: downloadURL,
                duration: Math.round(audioBlob.size / 16000), // Approximate duration
                senderId: currentUserId,
                senderName: currentUserName,
                timestamp: Date.now(),
                read: false
            });
            showNotification('Voice message sent!');
        }).catch((error) => {
            console.error("Voice message error:", error);
            showNotification('Voice message failed!', true);
        });
    }

    // NEW: Voice recording functionality
    function startVoiceRecording() {
        if (!navigator.mediaDevices) {
            showNotification('Voice recording not supported', true);
            return;
        }

        navigator.mediaDevices.getUserMedia({ audio: true })
            .then(stream => {
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                
                mediaRecorder.ondataavailable = (event) => {
                    audioChunks.push(event.data);
                };
                
                mediaRecorder.onstop = () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                    sendVoiceMessage(audioBlob);
                    stream.getTracks().forEach(track => track.stop());
                };
                
                mediaRecorder.start();
                isRecording = true;
                voiceBtn.textContent = '‚èπÔ∏è';
                voiceBtn.style.color = 'red';
                showNotification('Recording... Speak now');
            })
            .catch(error => {
                console.error("Microphone access error:", error);
                showNotification('Microphone access denied', true);
            });
    }

    function stopVoiceRecording() {
        if (mediaRecorder && isRecording) {
            mediaRecorder.stop();
            isRecording = false;
            voiceBtn.textContent = 'üé§';
            voiceBtn.style.color = '';
        }
    }

    // NEW: Notification system
    function showNotification(message, isError = false) {
        notification.textContent = message;
        notification.style.background = isError ? '#e74c3c' : '#25d366';
        notification.style.display = 'block';
        
        setTimeout(() => {
            notification.style.display = 'none';
        }, 3000);
    }

    // NEW: Search functionality
    function searchMessages(query) {
        const roomRef = database.ref('rooms/' + currentRoom + '/messages');
        roomRef.once('value').then(snapshot => {
            const results = [];
            snapshot.forEach(childSnapshot => {
                const message = childSnapshot.val();
                if (message.text && message.text.toLowerCase().includes(query.toLowerCase())) {
                    results.push({
                        key: childSnapshot.key,
                        ...message
                    });
                }
            });
            
            displaySearchResults(results, query);
        });
    }

    function displaySearchResults(results, query) {
        messagesDiv.innerHTML = '';
        
        if (results.length === 0) {
            messagesDiv.innerHTML = `<div class="message received">No messages found for "${query}"</div>`;
            return;
        }
        
        results.forEach(result => {
            const isSentByMe = (result.senderId === currentUserId);
            displayMessage(result, result.key, isSentByMe);
        });
    }

    // NEW: Profile management
    function showUserProfile() {
        profileInfo.innerHTML = `
            <p><strong>Name:</strong> ${currentUserName}</p>
            <p><strong>User ID:</strong> ${currentUserId}</p>
            <p><strong>Status:</strong> Online</p>
            <p><strong>Joined:</strong> ${new Date().toLocaleDateString()}</p>
        `;
        profileModal.style.display = 'flex';
    }

    // NEW: Export chats functionality
    function exportChats() {
        const roomRef = database.ref('rooms/' + currentRoom + '/messages');
        roomRef.once('value').then(snapshot => {
            const messages = [];
            snapshot.forEach(childSnapshot => {
                messages.push(childSnapshot.val());
            });
            
            const chatData = {
                room: currentRoom,
                exportDate: new Date().toISOString(),
                messages: messages
            };
            
            const dataStr = JSON.stringify(chatData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `whatsapp-chat-${currentRoom}-${Date.now()}.json`;
            link.click();
            
            showNotification('Chat exported successfully!');
        });
    }

    // Initialize Emoji Picker
    function initEmojiPicker() {
        emojis.forEach(emoji => {
            const emojiElement = document.createElement('span');
            emojiElement.className = 'emoji';
            emojiElement.textContent = emoji;
            emojiElement.addEventListener('click', () => {
                messageInput.value += emoji;
                messageInput.focus();
            });
            emojiPicker.appendChild(emojiElement);
        });
    }

    // Theme Toggle
    themeToggle.addEventListener('click', () => {
        isDarkTheme = !isDarkTheme;
        document.body.classList.toggle('dark-theme', isDarkTheme);
        themeToggle.textContent = isDarkTheme ? '‚òÄÔ∏è' : 'üåô';
    });

    // Online Users Toggle
    onlineUsersBtn.addEventListener('click', () => {
        onlineUsers.style.display = onlineUsers.style.display === 'block' ? 'none' : 'block';
        roomsMenu.style.display = 'none';
        settingsMenu.style.display = 'none';
    });

    // Rooms Menu Toggle
    roomsBtn.addEventListener('click', () => {
        roomsMenu.style.display = roomsMenu.style.display === 'block' ? 'none' : 'block';
        onlineUsers.style.display = 'none';
        settingsMenu.style.display = 'none';
    });

    // NEW: Settings Menu Toggle
    settingsBtn.addEventListener('click', () => {
        settingsMenu.style.display = settingsMenu.style.display === 'block' ? 'none' : 'block';
        onlineUsers.style.display = 'none';
        roomsMenu.style.display = 'none';
    });

    // NEW: Search Toggle
    searchBtn.addEventListener('click', () => {
        searchContainer.style.display = 'block';
        searchInput.focus();
    });

    closeSearch.addEventListener('click', () => {
        searchContainer.style.display = 'none';
        // Reload original messages
        startMessageListener();
    });

    // NEW: Search input handler
    searchInput.addEventListener('input', (e) => {
        if (e.target.value.length > 2) {
            searchMessages(e.target.value);
        } else if (e.target.value.length === 0) {
            // Reload original messages when search is cleared
            startMessageListener();
        }
    });

    // NEW: Profile button handler
    profileBtn.addEventListener('click', showUserProfile);
    closeProfile.addEventListener('click', () => {
        profileModal.style.display = 'none';
    });

    // NEW: File attachment handler
    attachBtn.addEventListener('click', () => {
        fileInput.click();
    });

    fileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const fileType = file.type.split('/')[0];
        if (fileType === 'image') {
            sendFileMessage(file, 'image');
        } else if (fileType === 'video') {
            sendFileMessage(file, 'video');
        } else {
            sendFileMessage(file, 'file');
        }
        
        // Reset file input
        fileInput.value = '';
    });

    // NEW: Voice message handlers
    voiceBtn.addEventListener('mousedown', startVoiceRecording);
    voiceBtn.addEventListener('mouseup', stopVoiceRecording);
    voiceBtn.addEventListener('touchstart', (e) => {
        e.preventDefault();
        startVoiceRecording();
    });
    voiceBtn.addEventListener('touchend', (e) => {
        e.preventDefault();
        stopVoiceRecording();
    });

    // NEW: Settings menu handlers
    document.getElementById('exportChats').addEventListener('click', exportChats);
    document.getElementById('changeWallpaper').addEventListener('click', () => {
        showNotification('Wallpaper change feature coming soon!');
    });
    document.getElementById('fontSize').addEventListener('click', () => {
        showNotification('Font size settings coming soon!');
    });
    document.getElementById('notificationSettings').addEventListener('click', () => {
        showNotification('Notification settings coming soon!');
    });
    document.getElementById('privacySettings').addEventListener('click', () => {
        showNotification('Privacy settings coming soon!');
    });

    // Typing Indicator
    messageInput.addEventListener('input', () => {
        if (!currentUserId) return;
        
        database.ref('typing/' + currentUserId).set({
            typing: true,
            name: currentUserName,
            timestamp: Date.now()
        });
        
        if (typingTimer) clearTimeout(typingTimer);
        
        typingTimer = setTimeout(() => {
            database.ref('typing/' + currentUserId).set({
                typing: false,
                name: currentUserName,
                timestamp: Date.now()
            });
        }, 2000);
    });

    // Listen for typing
    function setupTypingListener() {
        database.ref('typing').on('value', (snapshot) => {
            let someoneTyping = false;
            let typers = [];
            
            snapshot.forEach((childSnapshot) => {
                const typingData = childSnapshot.val();
                if (typingData.typing && childSnapshot.key !== currentUserId) {
                    someoneTyping = true;
                    typers.push(typingData.name);
                }
            });
            
            if (someoneTyping) {
                typingIndicator.textContent = typers.join(', ') + (typers.length === 1 ? ' is typing...' : ' are typing...');
                typingIndicator.style.display = 'block';
            } else {
                typingIndicator.style.display = 'none';
            }
        });
    }

    // Enhanced Message Display with Context Menu
    function startMessageListener() {
        const roomRef = database.ref('rooms/' + currentRoom + '/messages');
        
        roomRef.on('value', (snapshot) => {
            console.log("üì® New messages received from Firebase");
            messagesDiv.innerHTML = '';
            loadingMessages.style.display = 'none';
            
            let messageCount = 0;
            
            snapshot.forEach((childSnapshot) => {
                messageCount++;
                const message = childSnapshot.val();
                const messageKey = childSnapshot.key;
                const isSentByMe = (message.senderId === currentUserId);
                
                displayMessage(message, messageKey, isSentByMe);
            });
            
            console.log(`üìä Loaded ${messageCount} messages`);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        });
    }

    function displayMessage(message, messageKey, isSentByMe) {
        const senderName = message.senderName || (isSentByMe ? "You" : "Unknown");
        const messageElement = document.createElement('div');
        messageElement.classList.add('message', isSentByMe ? 'sent' : 'received');
        
        const time = new Date(message.timestamp || Date.now()).toLocaleTimeString([], { 
            hour: '2-digit', minute: '2-digit' 
        });
        
        let messageContent = '';
        
        // Handle different message types
        if (message.type === 'image') {
            messageContent = `
                <img src="${message.fileUrl}" alt="Shared image" class="image-message" onclick="window.open('${message.fileUrl}', '_blank')">
                <div class="file-name">${message.fileName}</div>
            `;
        } else if (message.type === 'file') {
            const fileExt = message.fileName.split('.').pop();
            const fileIcon = fileIcons[fileExt] || fileIcons.default;
            messageContent = `
                <div class="file-message">
                    <div class="file-info">
                        <span class="file-icon">${fileIcon}</span>
                        <div>
                            <div class="file-name">${message.fileName}</div>
                            <div class="file-size">${formatFileSize(message.fileSize)}</div>
                            <button class="download-btn" onclick="window.open('${message.fileUrl}', '_blank')">Download</button>
                        </div>
                    </div>
                </div>
            `;
        } else if (message.type === 'voice') {
            messageContent = `
                <div class="voice-message">
                    <button class="voice-play-btn" onclick="playVoiceMessage('${message.voiceUrl}')">‚ñ∂Ô∏è</button>
                    <div class="voice-duration">${message.duration || '0'}s</div>
                </div>
            `;
        } else {
            // Text message
            messageContent = message.text;
        }
        
        // Edited indicator
        const editedIndicator = message.edited ? ' <small style="color: #999;">(edited)</small>' : '';
        
        // Read receipt (double tick)
        const readReceipt = isSentByMe ? 
            `<span class="timestamp-tick ${message.read ? 'double-tick' : ''}">${time} ${message.read ? '‚úì‚úì' : '‚úì'}</span>` :
            `<span class="timestamp-tick">${time}</span>`;
        
        // Starred indicator
        const starredIndicator = message.starred ? '<span class="starred-icon">‚≠ê</span>' : '';
        
        messageElement.innerHTML = `
            <span class="sender-name">${senderName}</span>
            ${messageContent}
            ${readReceipt}
            ${editedIndicator}
            ${starredIndicator}
        `;
        
        // CONTEXT MENU FOR MESSAGES - ALL FEATURES WORKING
        messageElement.addEventListener('contextmenu', (e) => {
            e.preventDefault();
            showContextMenu(e, messageKey, message, isSentByMe);
        });
        
        // Long press for mobile
        let pressTimer;
        messageElement.addEventListener('touchstart', (e) => {
            e.stopPropagation();
            pressTimer = setTimeout(() => {
                showContextMenu(e, messageKey, message, isSentByMe);
            }, 800);
        });
        
        messageElement.addEventListener('touchend', () => {
            clearTimeout(pressTimer);
        });
        
        messageElement.addEventListener('touchmove', () => {
            clearTimeout(pressTimer);
        });
        
        messagesDiv.appendChild(messageElement);
    }

    // NEW: Format file size
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    // NEW: Play voice message
    function playVoiceMessage(url) {
        const audio = new Audio(url);
        audio.play().catch(error => {
            console.error("Audio play error:", error);
            showNotification('Cannot play voice message', true);
        });
    }

    // ENHANCED CONTEXT MENU - ALL OPTIONS WORKING
    function showContextMenu(e, key, message, isSentByMe) {
        e.preventDefault();
        e.stopPropagation();
        
        // Update context menu options based on message ownership
        document.getElementById('editOption').style.display = isSentByMe ? 'block' : 'none';
        document.getElementById('deleteOption').style.display = isSentByMe ? 'block' : 'none';
        
        contextMenu.style.display = 'block';
        contextMenu.style.left = e.clientX + 'px';
        contextMenu.style.top = e.clientY + 'px';
        
        // Adjust position if near edges
        if (e.clientX + contextMenu.offsetWidth > window.innerWidth) {
            contextMenu.style.left = window.innerWidth - contextMenu.offsetWidth - 10 + 'px';
        }
        if (e.clientY + contextMenu.offsetHeight > window.innerHeight) {
            contextMenu.style.top = window.innerHeight - contextMenu.offsetHeight - 10 + 'px';
        }
        
        // Set up context menu actions
        setupContextMenuActions(key, message, isSentByMe);
    }

    function setupContextMenuActions(key, message, isSentByMe) {
        // Clear previous event listeners
        const replyOption = document.getElementById('replyOption');
        const editOption = document.getElementById('editOption');
        const forwardOption = document.getElementById('forwardOption');
        const deleteOption = document.getElementById('deleteOption');
        const reactOption = document.getElementById('reactOption');
        const starOption = document.getElementById('starOption');
        
        // Remove existing listeners
        replyOption.replaceWith(replyOption.cloneNode(true));
        editOption.replaceWith(editOption.cloneNode(true));
        forwardOption.replaceWith(forwardOption.cloneNode(true));
        deleteOption.replaceWith(deleteOption.cloneNode(true));
        reactOption.replaceWith(reactOption.cloneNode(true));
        starOption.replaceWith(starOption.cloneNode(true));
        
        // Get new references
        const newReplyOption = document.getElementById('replyOption');
        const newEditOption = document.getElementById('editOption');
        const newForwardOption = document.getElementById('forwardOption');
        const newDeleteOption = document.getElementById('deleteOption');
        const newReactOption = document.getElementById('reactOption');
        const newStarOption = document.getElementById('starOption');
        
        // Reply action
        newReplyOption.addEventListener('click', () => {
            replyToMessage = {
                key: key,
                text: message.text,
                senderName: message.senderName
            };
            replySender.textContent = message.senderName;
            replyText.textContent = message.text || 'Message';
            replyPreview.style.display = 'block';
            messageInput.focus();
            contextMenu.style.display = 'none';
            console.log("üîÅ Reply option clicked");
        });
        
        // Edit action (only own messages)
        if (isSentByMe) {
            newEditOption.addEventListener('click', () => {
                editMessageKey = key;
                messageInput.value = message.text;
                messageInput.focus();
                contextMenu.style.display = 'none';
                console.log("‚úèÔ∏è Edit option clicked");
            });
        }
        
        // Forward action
        newForwardOption.addEventListener('click', () => {
            if (confirm("Forward this message?")) {
                const roomRef = database.ref('rooms/' + currentRoom + '/messages');
                roomRef.push({
                    text: message.text,
                    senderId: currentUserId,
                    senderName: currentUserName,
                    timestamp: Date.now(),
                    forwarded: true,
                    originalSender: message.senderName
                });
                console.log("üîÑ Message forwarded");
            }
            contextMenu.style.display = 'none';
        });
        
        // Delete action (only own messages)
        if (isSentByMe) {
            newDeleteOption.addEventListener('click', () => {
                if (confirm("Delete this message?")) {
                    const roomRef = database.ref('rooms/' + currentRoom + '/messages');
                    roomRef.child(key).remove()
                        .then(() => {
                            console.log("üóëÔ∏è Message deleted:", key);
                            contextMenu.style.display = 'none';
                        })
                        .catch((error) => {
                            console.error("Error deleting message:", error);
                            alert("Message delete nahi ho saka.");
                        });
                }
            });
        }
        
        // NEW: React action
        newReactOption.addEventListener('click', () => {
            // Show reaction picker
            reactionPicker.style.display = 'block';
            reactionPicker.style.left = (event.clientX - 50) + 'px';
            reactionPicker.style.top = (event.clientY - 50) + 'px';
            contextMenu.style.display = 'none';
        });
        
        // NEW: Star action
        newStarOption.addEventListener('click', () => {
            const roomRef = database.ref('rooms/' + currentRoom + '/messages');
            roomRef.child(key).update({
                starred: !message.starred
            });
            contextMenu.style.display = 'none';
            showNotification(message.starred ? 'Message unstarred' : 'Message starred');
        });
    }

    // NEW: Reaction picker handler
    reactionPicker.addEventListener('click', (e) => {
        if (e.target.classList.contains('emoji')) {
            const reaction = e.target.textContent;
            // Here you would save the reaction to Firebase
            showNotification(`Reacted with ${reaction}`);
            reactionPicker.style.display = 'none';
        }
    });

    // Cancel Reply
    cancelReply.addEventListener('click', () => {
        replyPreview.style.display = 'none';
        replyToMessage = null;
    });

    // Emoji Picker Toggle
    emojiBtn.addEventListener('click', () => {
        emojiPicker.style.display = emojiPicker.style.display === 'block' ? 'none' : 'block';
    });

    // Close emoji picker when clicking outside
    document.addEventListener('click', (e) => {
        if (!emojiBtn.contains(e.target) && !emojiPicker.contains(e.target)) {
            emojiPicker.style.display = 'none';
        }
        if (!onlineUsersBtn.contains(e.target) && !onlineUsers.contains(e.target)) {
            onlineUsers.style.display = 'none';
        }
        if (!roomsBtn.contains(e.target) && !roomsMenu.contains(e.target)) {
            roomsMenu.style.display = 'none';
        }
        if (!settingsBtn.contains(e.target) && !settingsMenu.contains(e.target)) {
            settingsMenu.style.display = 'none';
        }
        if (!searchBtn.contains(e.target) && !searchContainer.contains(e.target)) {
            searchContainer.style.display = 'none';
        }
        contextMenu.style.display = 'none';
        reactionPicker.style.display = 'none';
    });

    // SIMPLE EVENT LISTENERS - GUARANTEED TO WORK
    function setupEventListeners() {
        console.log("Setting up event listeners...");
        
        // Send button click
        sendButton.addEventListener('click', function(e) {
            e.preventDefault();
            console.log("üü¢ Send button clicked!");
            sendMessage();
        });
        
        // Enter key in message input
        messageInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                console.log("üü¢ Enter key pressed!");
                sendMessage();
            }
        });
        
        console.log("‚úÖ Event listeners setup complete");
    }

    // Initialize everything when page loads
    window.addEventListener('load', function() {
        console.log("üöÄ Page loaded - initializing app...");
        
        initEmojiPicker();
        setupEventListeners();
        setupNavigation(); // NEW: Initialize navigation
        
        // Force send button to be visible
        sendButton.style.display = 'flex';
        sendButton.style.visibility = 'visible';
        sendButton.style.opacity = '1';
        
        console.log("üü¢ Starting Firebase authentication...");
        
        auth.signInAnonymously()
            .then(async (userCredential) => {
                currentUserId = userCredential.user.uid;
                console.log("‚úÖ User signed in:", currentUserId);
                
                const userRef = database.ref('users/' + currentUserId);
                const nameSnapshot = await userRef.child('displayName').once('value');
                
                if (nameSnapshot.exists()) {
                    currentUserName = nameSnapshot.val();
                    console.log("‚úÖ User name found:", currentUserName);
                    
                    setupUserStatus(currentUserId);
                    setupTypingListener();
                    setupOnlineUsers();
                    startMessageListener();
                    
                    console.log("üéâ App ready! You can start chatting.");
                } else {
                    console.log("üü° No user name - showing modal");
                    nameModal.style.display = 'flex';
                    nameInput.focus();
                }
            })
            .catch((error) => {
                console.error("‚ùå Sign-in error:", error);
                alert("Firebase connection error. Internet check karein.");
            });
    });

    // Name submission handler
    function handleNameSubmission() {
        let name = nameInput.value.trim();
        
        if (!name) {
            alert("Naam zaroor dein taake doosre aapko pehchaan saken.");
            return;
        }
        
        currentUserName = name;
        const userRef = database.ref('users/' + currentUserId);
        
        userRef.child('displayName').set(currentUserName)
            .then(() => {
                nameModal.style.display = 'none';
                console.log("‚úÖ User name saved:", currentUserName);
                
                setupUserStatus(currentUserId);
                setupTypingListener();
                setupOnlineUsers();
                startMessageListener();
                
                alert("üéâ Welcome " + currentUserName + "! Ab aap chat kar sakte hain.");
            })
            .catch(error => {
                console.error("‚ùå Error saving name:", error);
                alert("Name save nahi ho saka. Internet check karein.");
            });
    }

    submitNameButton.addEventListener('click', handleNameSubmission);
    nameInput.addEventListener('keypress', function (e) {
        if (e.key === 'Enter') {
            handleNameSubmission();
        }
    });

    // User status setup
    function setupUserStatus(uid) {
        const userStatusRef = database.ref('status/' + uid);
        const isOnline = { state: 'online', last_seen: firebase.database.ServerValue.TIMESTAMP };
        const isOffline = { state: 'offline', last_seen: firebase.database.ServerValue.TIMESTAMP };

        userStatusRef.onDisconnect().set(isOffline).then(() => {
            userStatusRef.set(isOnline);
        });

        otherUserId = 'zohaib_fixed_id';
        
        database.ref('status/' + otherUserId).on('value', (snapshot) => {
            const status = snapshot.val();
            const dot = document.getElementById('otherUserStatus');
            const text = document.getElementById('statusText');
            
            if (status && status.state === 'online') {
                dot.classList.add('online');
                text.textContent = 'Online';
            } else {
                dot.classList.remove('online');
                if (status && status.last_seen) {
                    const date = new Date(status.last_seen);
                    text.textContent = 'Last seen: ' + date.toLocaleTimeString();
                } else {
                    text.textContent = 'Offline';
                }
            }
        });
    }

    // Online Users Management
    function setupOnlineUsers() {
        const usersRef = database.ref('users');
        const statusRef = database.ref('status');
        
        statusRef.on('value', (snapshot) => {
            usersList.innerHTML = '';
            snapshot.forEach((childSnapshot) => {
                const status = childSnapshot.val();
                if (status.state === 'online' && childSnapshot.key !== currentUserId) {
                    usersRef.child(childSnapshot.key).child('displayName').once('value', (nameSnapshot) => {
                        const userName = nameSnapshot.val() || 'Unknown User';
                        const userItem = document.createElement('div');
                        userItem.className = 'user-item';
                        userItem.innerHTML = `
                            <span class="user-dot"></span>
                            ${userName}
                        `;
                        usersList.appendChild(userItem);
                    });
                }
            });
        });
    }

    // Chat Room Management
    function setupChatRooms() {
        roomItems.forEach(item => {
            item.addEventListener('click', () => {
                const room = item.getAttribute('data-room');
                const password = item.getAttribute('data-password');
                
                if (password) {
                    // Show password modal for locked rooms
                    roomModalText.textContent = `Enter password for ${room}`;
                    roomModal.style.display = 'flex';
                    roomPassword.value = '';
                    roomPassword.focus();
                    
                    submitRoomButton.onclick = () => {
                        if (roomPassword.value === password) {
                            joinRoom(room);
                            roomModal.style.display = 'none';
                        } else {
                            alert("‚ùå Galat password! Sahi password likhein.");
                        }
                    };
                    
                    roomPassword.addEventListener('keypress', function(e) {
                        if (e.key === 'Enter') {
                            if (roomPassword.value === password) {
                                joinRoom(room);
                                roomModal.style.display = 'none';
                            } else {
                                alert("‚ùå Galat password! Sahi password likhein.");
                            }
                        }
                    });
                } else {
                    // No password required for general chat
                    joinRoom(room);
                }
            });
        });
    }

    function joinRoom(room) {
        currentRoom = room;
        currentRoomName.textContent = room;
        
        // Clear current messages
        messagesDiv.innerHTML = '';
        loadingMessages.style.display = 'block';
        
        // Start listening to messages in the new room
        startMessageListener();
        
        console.log(`‚úÖ Joined room: ${room}`);
        roomsMenu.style.display = 'none';
    }

    // Initialize chat rooms
    setupChatRooms();

    console.log("ü§ñ ZB WhatsApp Pro Loaded Successfully!");
    console.log("‚ú® Features Available:");
    console.log("‚úÖ Send Messages");
    console.log("‚úÖ Edit Messages (Right-click your messages)");
    console.log("‚úÖ Reply to Messages (Right-click any message)");
    console.log("‚úÖ Forward Messages (Right-click any message)");
    console.log("‚úÖ Delete Messages (Right-click your messages)");
    console.log("‚úÖ Emoji Picker");
    console.log("‚úÖ Online Status");
    console.log("‚úÖ Dark/Light Theme");
    console.log("‚úÖ Chat Rooms with Passwords");
    console.log("‚úÖ NEW: File Sharing (Images, Documents)");
    console.log("‚úÖ NEW: Voice Messages");
    console.log("‚úÖ NEW: Message Search");
    console.log("‚úÖ NEW: User Profiles");
    console.log("‚úÖ NEW: Chat Export");
    console.log("‚úÖ NEW: Message Reactions");
    console.log("‚úÖ NEW: Starred Messages");
    console.log("‚úÖ NEW: Notifications");
    console.log("‚úÖ NEW: Settings Menu");
    console.log("‚úÖ NEW: WhatsApp-style Navigation Bar");
  </script>
</body>
</html>