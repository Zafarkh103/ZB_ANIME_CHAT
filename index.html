<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ZB AnimeChat Pro - ZAFAR Rooms</title>
  
  <style>
    /* WhatsApp UI Base */
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background: #000;
      color: #fff;
      width: 100%;
      height: 100vh;
      overflow: hidden;
    }
    
    /* ANIME BACKGROUND */
    .anime-bg {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -2;
      background-image: url('background.png');
      background-size: cover;
      background-position: center;
      opacity: 0.5;
      filter: brightness(0.8) contrast(1.3) saturate(1.5);
      transition: background-image 1s ease;
    }
    
    /* RED ANIME LIGHTING EFFECT */
    .red-light {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: radial-gradient(circle at 20% 50%, rgba(255, 45, 45, 0.4) 0%, transparent 50%),
                  radial-gradient(circle at 80% 20%, rgba(255, 20, 20, 0.3) 0%, transparent 50%);
      z-index: -1;
      mix-blend-mode: screen;
    }
    
    /* WhatsApp Header */
    .chat-header {
      position: fixed;
      top: 0;
      width: 0%;
      background: rgba(0, 0, 0, 0.9);
      backdrop-filter: blur(15px);
      padding: 12px px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid rgba(255, 45, 45, 0.3);
      z-index: 100;
      height: 60px;
      box-sizing: border-box;
    }
    
    .header-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .logo {
      width: 120px;
      height: 50px;
      border-radius: 10px;
      overflow: hidden;
      border: 2px solid #ff2d2d;
      background: linear-gradient(135deg, #ff2d2d, #b30000);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
      box-shadow: 0 0 20px rgba(255, 45, 45, 0.6);
    }
    
    .header-text h2 {
      margin: 0;
      font-size: 18px;
      color: #ff2d2d;
      text-shadow: 0 0 10px rgba(255, 45, 45, 0.5);
    }
    
    .header-text small {
      font-size: 12px;
      opacity: 0.7;
    }
    
    /* Chat Container */
    .chat-container {
      position: fixed;
      top: 60px;
      bottom: 110px;
      width: 100%;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      padding: 10px;
      box-sizing: border-box;
    }
    
    .messages {
      display: flex;
      flex-direction: column;
      gap: 10px;
      min-height: 100%;
    }
    
    /* Message Bubbles */
    .message {
      max-width: 80%;
      padding: 12px 16px;
      border-radius: 18px;
      position: relative;
      word-wrap: break-word;
      backdrop-filter: blur(5px);
      animation: fadeIn 0.3s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .sent {
      align-self: flex-end;
      background: linear-gradient(135deg, #0084ff, #0066cc);
      color: white;
      border-bottom-right-radius: 5px;
      box-shadow: 0 5px 20px rgba(0, 132, 255, 0.4);
    }
    
    .received {
      align-self: flex-start;
      background: rgba(255, 255, 255, 0.08);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-bottom-left-radius: 5px;
    }
    
    .sender-name {
      font-size: 12px;
      font-weight: bold;
      margin-bottom: 4px;
      opacity: 0.9;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .message-time {
      font-size: 10px;
      opacity: 0.6;
      margin-left: 10px;
    }
    
    /* Message Actions */
    .message-actions {
      display: none;
      gap: 10px;
      margin-top: 8px;
      padding-top: 8px;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      justify-content: flex-end;
    }
    
    .message-action-btn {
      background: none;
      border: none;
      color: rgba(255, 255, 255, 0.5);
      font-size: 14px;
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 4px;
      transition: all 0.2s;
    }
    
    .message-action-btn:hover {
      background: rgba(255, 255, 255, 0.1);
      color: white;
    }
    
    /* Input Area */
    .input-area {
      position: fixed;
      bottom: 50px;
      width: 100%;
      padding: 12px 15px;
      background: rgba(0, 0, 0, 0.85);
      backdrop-filter: blur(15px);
      border-top: 1px solid rgba(255, 45, 45, 0.2);
      display: flex;
      gap: 10px;
      z-index: 100;
      box-sizing: border-box;
    }
    
    #messageInput {
      flex: 1;
      padding: 10px 20px;
      border-radius: 25px;
      border: none;
      background: rgba(255, 255, 255, 0.1);
      color: white;
      font-size: 14px;
      outline: none;
      border: 2px solid rgba(255, 45, 45, 0.3);
    }
    
    #messageInput::placeholder {
      color: rgba(255, 255, 255, 0.5);
    }
    
    #sendButton {
      width: 50px;
      height: 42px;
      border-radius: 50%;
      border: none;
      background: linear-gradient(135deg, #ff2d2d, #b30000);
      color: white;
      font-size: 18px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 5px 15px rgba(255, 45, 45, 0.5);
    }
    
    /* Emoji Picker */
    .emoji-picker {
      position: fixed;
      bottom: 110px;
      right: 15px;
      background: rgba(0, 0, 0, 0.95);
      border: 1px solid rgba(255, 45, 45, 0.3);
      border-radius: 10px;
      padding: 10px;
      display: none;
      grid-template-columns: repeat(6, 1fr);
      gap: 5px;
      max-width: 200px;
      z-index: 1000;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.5);
    }
    
    .emoji-btn {
      background: none;
      border: none;
      color: white;
      font-size: 20px;
      cursor: pointer;
      padding: 5px;
      border-radius: 5px;
      transition: background 0.2s;
    }
    
    .emoji-btn:hover {
      background: rgba(255, 45, 45, 0.2);
    }
    
    /* Bottom Navigation */
    .nav-bar {
      position: fixed;
      bottom: 0;
      width: 100%;
      background: rgba(0, 0, 0, 0.95);
      backdrop-filter: blur(15px);
      display: flex;
      height: 50px;
      border-top: 1px solid rgba(255, 45, 45, 0.2);
      z-index: 100;
    }
    
    .nav-item {
      flex: 1;
      text-align: center;
      color: rgba(255, 255, 255, 0.6);
      font-size: 12px;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }
    
    .nav-item.active {
      color: #ff2d2d;
      text-shadow: 0 0 10px rgba(255, 45, 45, 0.5);
    }
    
    .nav-icon {
      font-size: 20px;
      margin-bottom: 2px;
    }
    
    /* Sidebars */
    .sidebar, .online-sidebar {
      position: fixed;
      top: 0;
      width: 280px;
      height: 100%;
      background: rgba(0, 0, 0, 0.98);
      backdrop-filter: blur(25px);
      z-index: 1000;
      transition: transform 0.3s ease;
      overflow-y: auto;
      padding: 20px;
      box-sizing: border-box;
    }
    
    .sidebar {
      left: 0;
      transform: translateX(-100%);
      border-right: 2px solid rgba(255, 45, 45, 0.3);
    }
    
    .sidebar.show {
      transform: translateX(0);
    }
    
    .online-sidebar {
      right: 0;
      transform: translateX(100%);
      border-left: 2px solid rgba(0, 132, 255, 0.3);
    }
    
    .online-sidebar.show {
      transform: translateX(0);
    }
    
    .chatroom {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      margin-bottom: 10px;
      background: rgba(255, 255, 255, 0.09);
      border-radius: 12px;
      cursor: pointer;
      transition: 0.3s;
      border: 1px solid transparent;
    }
    
    .chatroom:hover {
      background: rgba(255, 45, 45, 0.15);
      border-color: rgba(255, 45, 45, 0.5);
    }
    
    .chatroom.active {
      background: rgba(255, 45, 45, 0.2);
      border-color: rgba(255, 45, 45, 0.7);
      box-shadow: 0 5px 15px rgba(255, 45, 45, 0.2);
    }
    
    .room-avatar {
      width: 50px;
      height: 50px;
      border-radius: 10px;
      background: linear-gradient(135deg, #ff2d2d, #b30000);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
    }
    
    /* Online Users */
    .online-user {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px;
      margin-bottom: 8px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 10px;
      border-left: 3px solid #25d366;
    }
    
    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, #0084ff, #0066cc);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
    }
    
    /* STICKER MENU (NEW) */
    .sticker-menu {
      position: fixed;
      bottom: 100px;
      left: 0px;
      right: 0px;
      background: rgba(0, 0, 0, 0.00);
      border: 3px solid rgba(255, 45, 45, 0.5);
      border-radius: 15px;
      z-index: 1000;
      display: none;
      flex-direction: column;
      max-height: 350px;
      box-shadow: 0 10px 30px rgba(255, 45, 45, 0.4);
    }
    
    .sticker-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 15px;
      border-bottom: 1px solid rgba(255, 45, 45, 0.3);
      background: rgba(255, 45, 45, 0.15);
      border-radius: 15px 15px 0 0;
    }
    
    .sticker-header h3 {
      margin: 0;
      color: #ff2d2d;
      font-size: 16px;
      text-shadow: 0 0 10px rgba(255, 45, 45, 0.5);
    }
    
    .close-sticker-menu {
      background: none;
      border: none;
      color: #ff2d2d;
      font-size: 20px;
      cursor: pointer;
      width: 30px;
      height: 30px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s;
    }
    
    .close-sticker-menu:hover {
      background: rgba(255, 45, 45, 0.3);
      transform: rotate(90deg);
    }
    
    .sticker-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 12px;
      padding: 15px;
      overflow-y: auto;
    }
    
    .sticker-item {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 12px;
      padding: 10px;
      cursor: pointer;
      transition: all 0.3s;
      border: 2px solid transparent;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .sticker-item:hover {
      background: rgba(255, 45, 45, 0.2);
      border-color: rgba(255, 45, 45, 0.7);
      transform: scale(1.1);
      box-shadow: 0 5px 15px rgba(255, 45, 45, 0.3);
    }
    
    .sticker-item img {
      width: 60px;
      height: 60px;
      object-fit: contain;
      pointer-events: none;
    }
    
    .sticker-btn {
      background: linear-gradient(135deg, #ff2d2d, #b30000);
      color: white;
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      font-size: 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 5px 15px rgba(255, 45, 45, 0.5);
      transition: all 0.3s;
    }
    
    .sticker-btn:hover {
      transform: scale(1.1);
      box-shadow: 0 8px 20px rgba(255, 45, 45, 0.7);
    }
    
    /* Modals */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.95);
      z-index: 2000;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(10px);
    }
    
    .modal-content {
      background: rgba(20, 8, 12, 0.98);
      padding: 25px;
      border-radius: 15px;
      width: 90%;
      max-width: 350px;
      border: 2px solid rgba(255, 45, 45, 0.5);
      box-shadow: 0 0 40px rgba(255, 45, 45, 0.3);
      text-align: center;
    }
    
    .modal-content input {
      width: 100%;
      padding: 12px 15px;
      margin: 15px 0;
      border-radius: 10px;
      border: 1px solid rgba(255, 45, 45, 0.5);
      background: rgba(0, 0, 0, 0.5);
      color: white;
      font-size: 14px;
      box-sizing: border-box;
    }
    
    .modal-content button {
      background: linear-gradient(135deg, #ff2d2d, #b30000);
      color: white;
      border: none;
      padding: 12px 25px;
      border-radius: 10px;
      font-size: 14px;
      cursor: pointer;
      width: 100%;
      margin-top: 10px;
      box-shadow: 0 5px 15px rgba(255, 45, 45, 0.3);
    }
    
    /* Loading */
    .loading {
      text-align: center;
      padding: 20px;
      color: rgba(255, 255, 255, 0.6);
    }
    
    /* Secret Panel */
    .secret-container {
      position: fixed;
      top: 70px;
      right: 10px;
      background: rgba(0, 0, 0, 0.98);
      padding: 15px;
      border-radius: 10px;
      border: 2px solid #ff2d2d;
      display: none;
      box-shadow: 0 0 30px rgba(255, 45, 45, 0.3);
      max-width: 250px;
      z-index: 1000;
    }
    
    /* Mobile Responsive */
    @media (max-width: 768px) {
      .sidebar, .online-sidebar {
        width: 85%;
      }
      
      .chat-container {
        padding: 8px;
      }
      
      .message {
        max-width: 85%;
      }
      
      .sticker-grid {
        grid-template-columns: repeat(4, 1fr);
        gap: 10px;
        padding: 12px;
      }
      
      .sticker-item img {
        width: 50px;
        height: 50px;
      }
    }
    
    @media (max-width: 480px) {
      .sticker-grid {
        grid-template-columns: repeat(3, 1fr);
      }
    }
  </style>
</head>
<body>
  <!-- Anime Background -->
  <div class="anime-bg" id="animeBg"></div>
  <div class="red-light"></div>
  
  <!-- Sticker Menu (NEW) -->
  <div class="sticker-menu" id="stickerMenu">
    <div class="sticker-header">
      <h3>üî• Anime Stickers Pack</h3>
      <button class="close-sticker-menu" id="closeStickerMenu">‚úï</button>
    </div>
    <div class="sticker-grid" id="stickerGrid">
      <!-- Stickers will be loaded here -->
    </div>
  </div>
  
  <!-- Secret Admin Panel -->
  <div class="secret-container" id="secretContainer">
    <h4 style="margin:0 0 10px 0;color:#ff2d2d;text-align:center;">üîí Secret Passwords</h4>
    <div style="font-size:12px;line-height:1.6;">
      <div><strong>Room 1:</strong> <span id="secretPass1" style="color:#25d366;">Loading...</span></div>
      <div><strong>Room 2:</strong> <span id="secretPass2" style="color:#25d366;">Loading...</span></div>
      <div><strong>Room 3:</strong> <span id="secretPass3" style="color:#25d366;">Loading...</span></div>
      <div><strong>Room 4:</strong> <span id="secretPass4" style="color:#25d366;">Loading...</span></div>
      <div><strong>Room 5:</strong> <span id="secretPass5" style="color:#25d366;">Loading...</span></div>
    </div>
    <button onclick="hideSecretPanel()" style="margin-top:10px;background:#ff2d2d;color:white;border:none;padding:5px 10px;border-radius:5px;font-size:10px;cursor:pointer;width:100%;">Close</button>
  </div>
  
  <!-- Header -->
  <div class="chat-header">
    <div class="header-left">
      <button id="menuBtn" style="background:none;border:none;color:#ff2d2d;font-size:22px;cursor:pointer;">‚ò∞</button>
      <div class="logo">ZAFIüß∏</div>
      <div class="header-text">
        <h2></h2>
        <small id="onlineCount">0 online</small>
      </div>
    </div>
    <div id="roomNameDisplay" style="color:#ff2d2d;font-weight:bold;font-size:14px;max-width:100px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">General Chat</div>
    <div style="display:flex;align-items:center;gap:10px;">
      <button id="onlineBtn" style="background:none;border:none;color:#25d366;font-size:18px;cursor:pointer;">Online üë§</button>
      <button id="secretBtn" style="background:none;border:none;color:#ff2d2d;font-size:18px;cursor:pointer;"></button>
    </div>
  </div>
  
  <!-- Chat Container -->
  <div class="chat-container" id="chatContainer">
    <div class="messages" id="messages">
      <div class="loading" id="loading">Loading messages...</div>
    </div>
  </div>
  
  <!-- Input Area -->
  <div class="input-area">
    <button class="sticker-btn" id="stickerBtn">„ã°</button>
    <button id="emojiBtn" style="background:none;border:none;color:#ff2d2d;font-size:20px;cursor:pointer;"></button>
    <input type="text" id="messageInput" placeholder="Type a message..." autocomplete="off">
    <button id="sendButton">‚û§</button>
  </div>
  
  <!-- Emoji Picker -->
  <div class="emoji-picker" id="emojiPicker">
    <button class="emoji-btn" data-emoji="üòÄ">üòÄ</button>
    <button class="emoji-btn" data-emoji="üòÇ">üòÇ</button>
    <button class="emoji-btn" data-emoji="üòç">üòç</button>
    <button class="emoji-btn" data-emoji="ü•∞">ü•∞</button>
    <button class="emoji-btn" data-emoji="üòé">üòé</button>
    <button class="emoji-btn" data-emoji="ü§©">ü§©</button>
    <button class="emoji-btn" data-emoji="üòä">üòä</button>
    <button class="emoji-btn" data-emoji="üôè">üôè</button>
    <button class="emoji-btn" data-emoji="üéâ">üéâ</button>
    <button class="emoji-btn" data-emoji="üáµüá∞">üáµüá∞</button>
    <button class="emoji-btn" data-emoji="üî•">üî•</button>
    <button class="emoji-btn" data-emoji="üíÄ">üíÄ</button>
  </div>
  
  <!-- Navigation -->
  <div class="nav-bar">
    <div class="nav-item active" data-tab="chat">
      <div class="nav-icon">üí¨</div>
      <div>Chat</div>
    </div>
    <div class="nav-item" data-tab="rooms">
      <div class="nav-icon">üîí</div>
      <div>Rooms</div>
    </div>
    <div class="nav-item" data-tab="theme">
      <div class="nav-icon">üñºÔ∏è</div>
      <div>Wallpapers</div>
    </div>
    <div class="nav-item" data-tab="online">
      <div class="nav-icon">üë§</div>
      <div><span id="onlineBadge">0</span> Online</div>
    </div>
  </div>
     <!-- Sidebars -->
  <div class="sidebar" id="sidebar">
    <h3 style="margin-top:0;color:#ff2d2d;text-align:center;">MADE IN PIKISTAN¬Æ2025</h3>
    
    <div class="chatroom active" data-room="general" data-bg="background.png">
      <div class="room-avatar">üåç</div>
      <div class="room-info">
        <h4>All World Chat ü•∂<span style="color:#25d366;">üîì</span></h4>
        <small>Public Chat‚Ä¢DONT SPAMüåõ</small>
      </div>
    </div>
    
    <div class="chatroom" data-room="Chatroom1" data-password=".1" data-bg="bg1.png">
      <div class="room-avatar">ùôï</div>
      <div class="room-info">
        <h4>Secret Room 1 <span style="color:#ff2d2d;">üîê</span></h4>
        <small style="color:#ff2d2d;background:rgba(255,45,45,0.1);padding:2px 8px;border-radius:10px;border:1px dashed rgba(255,45,45,0.3);">Password Protected</small>
      </div>
    </div>
    
    <div class="chatroom" data-room="Chatroom2" data-password="..2" data-bg="bg2.png">
      <div class="room-avatar">ùòº</div>
      <div class="room-info">
        <h4>Secret Room 2 <span style="color:#ff2d2d;">üîê</span></h4>
        <small style="color:#ff2d2d;background:rgba(255,45,45,0.1);padding:2px 8px;border-radius:10px;border:1px dashed rgba(255,45,45,0.3);">Password Protected</small>
      </div>
    </div>
    
    <div class="chatroom" data-room="Chatroom3" data-password="...3" data-bg="bg3.png">
      <div class="room-avatar">ùôÅ</div>
      <div class="room-info">
        <h4>Secret Room 3 <span style="color:#ff2d2d;">üîê</span></h4>
        <small style="color:#ff2d2d;background:rgba(255,45,45,0.1);padding:2px 8px;border-radius:10px;border:1px dashed rgba(255,45,45,0.3);">Password Protected</small>
      </div>
    </div>
    
    <div class="chatroom" data-room="Chatroom4" data-password="....4" data-bg="bg4.png">
      <div class="room-avatar">ùòº</div>
      <div class="room-info">
        <h4>Secret Room 4 <span style="color:#ff2d2d;">üîê</span></h4>
        <small style="color:#ff2d2d;background:rgba(255,45,45,0.1);padding:2px 8px;border-radius:10px;border:1px dashed rgba(255,45,45,0.3);">Password Protected</small>
      </div>
    </div>
    
    <div class="chatroom" data-room="Chatroom5" data-password=".....5" data-bg="bg5.png">
      <div class="room-avatar">ùôç</div>
      <div class="room-info">
        <h4>Secret Room 5 <span style="color:#ff2d2d;">üîê</span></h4>
        <small style="color:#ff2d2d;background:rgba(255,45,45,0.1);padding:2px 8px;border-radius:10px;border:1px dashed rgba(255,45,45,0.3);">Password Protected</small>
      </div>
    </div>
  </div>
  
  <div class="online-sidebar" id="onlineSidebar">
    <h3 style="margin-top:0;color:#25d366;text-align:center;">üë• Online Users</h3>
    <div id="onlineUsersList">
      <div class="loading">Loading users...</div>
    </div>
  </div>
  
  <!-- Modals -->
  <div class="modal" id="nameModal">
    <div class="modal-content">
      <h2>üáµüá∞ Welcome to ZB AnimeChat</h2>
      <p>Enter your name to start chatting:</p>
      <input type="text" id="nameInput" placeholder="Enter your name..." autocomplete="off">
      <button id="submitName">Start Chatting</button>
      <p style="font-size:12px;margin-top:15px;opacity:0.7;">
        üî• Real-time Chat<br>
        üîê 5 password protected rooms<br>
        üëë 10 FREE Anime Stickers<br>
        üë• Live Online Users
      </p>
    </div>
  </div>
  
  <div class="modal" id="passwordModal">
    <div class="modal-content">
      <h2>üîí Password Required</h2>
      <p id="roomPrompt">Enter password for this room:</p>
      <input type="password" id="passwordInput" placeholder="Enter password..." autocomplete="off">
      <button id="submitPassword">Join Room</button>
      <button id="cancelPassword" style="background:rgba(255,255,255,0.1);margin-top:5px;">Cancel</button>
    </div>
  </div>
</body>
</html>

<script>
// ========== APP CONFIGURATION ==========
const CONFIG = {
  SECRET_PASSWORDS: {
    "Chatroom1": "ZA****",
    "Chatroom2": "ZA****", 
    "Chatroom3": "ZA****",
    "Chatroom4": "ZA****",
    "Chatroom5": "ZA****"
  },
  
  STICKERS: [
    { id: 1, name: "Gold Ring", file: "1.gif" },
    { id: 2, name: "Gold Star", file: "2.gif" },
    { id: 3, name: "Diamond Hand", file: "3.gif" },
    { id: 4, name: "Gold Girl Watch", file: "4.gif" },
    { id: 5, name: "Diamond", file: "5.gif" },
    { id: 6, name: "Cute Bear", file: "6.gif" },
    { id: 7, name: "Gift Nicklaus", file: "7.gif" },
    { id: 8, name: "Gold Boy Watch", file: "8.gif" },
    { id: 9, name: "Gold", file: "9.gif" },
    { id: 10, name: "Heart", file: "10.gif" },
    { id: 11, name: "Gift box", file: "11.gif" },
    { id: 12, name: "Gold Bag", file: "12.gif" },
    { id: 13, name: "Gold cup", file: "13.gif" },
    { id: 14, name: "Red Folwer", file: "14.gif" },
    { id: 15, name: "Oh sticker", file: "15.gif" },
      ],
  
  FIREBASE_CONFIG: {
    apiKey: "AIzaSyB8zMhCjGxmHBpruABYA4pBj3jU0uMHCs0",
    authDomain: "zafi-chat-app.firebaseapp.com",
    projectId: "zafi-chat-app",
    storageBucket: "zafi-chat-app.firebasestorage.app",
    messagingSenderId: "989950346714",
    appId: "1:989950346714:web:7bad7f8fae2a72ce0bace3",
    measurementId: "G-XW5MS2D2K7",
    databaseURL: "https://zafi-chat-app-default-rtdb.asia-southeast1.firebasedatabase.app"
  }
};

// ========== APP STATE ==========
let currentUser = {
  name: localStorage.getItem('animechat_username') || '',
  id: '',
  room: 'general'
};

let app = {
  firebase: null,
  database: null,
  auth: null,
  onlineUsers: {},
  typingUsers: {},
  currentMessageListener: null // Track current room listener
};

// ========== DOM ELEMENTS ==========
const elements = {
  // Main elements
  chatContainer: document.getElementById('chatContainer'),
  messages: document.getElementById('messages'),
  messageInput: document.getElementById('messageInput'),
  sendButton: document.getElementById('sendButton'),
  
  // Sticker elements (NEW)
  stickerBtn: document.getElementById('stickerBtn'),
  stickerMenu: document.getElementById('stickerMenu'),
  closeStickerMenu: document.getElementById('closeStickerMenu'),
  stickerGrid: document.getElementById('stickerGrid'),
  
  // UI elements
  nameModal: document.getElementById('nameModal'),
  passwordModal: document.getElementById('passwordModal'),
  nameInput: document.getElementById('nameInput'),
  passwordInput: document.getElementById('passwordInput'),
  roomPrompt: document.getElementById('roomPrompt'),
  
  // Sidebars
  sidebar: document.getElementById('sidebar'),
  onlineSidebar: document.getElementById('onlineSidebar'),
  
  // Buttons
  menuBtn: document.getElementById('menuBtn'),
  onlineBtn: document.getElementById('onlineBtn'),
  secretBtn: document.getElementById('secretBtn'),
  emojiBtn: document.getElementById('emojiBtn'),
  emojiPicker: document.getElementById('emojiPicker'),
  
  // Info displays
  roomNameDisplay: document.getElementById('roomNameDisplay'),
  onlineCount: document.getElementById('onlineCount'),
  onlineBadge: document.getElementById('onlineBadge'),
  onlineUsersList: document.getElementById('onlineUsersList'),
  secretContainer: document.getElementById('secretContainer'),
  
  // Chatrooms
  chatrooms: document.querySelectorAll('.chatroom'),
  
  // Navigation
  navItems: document.querySelectorAll('.nav-item'),
  
  // Loading
  loading: document.getElementById('loading')
};

// ========== STICKER SYSTEM (NEW) ==========
function initStickerSystem() {
  console.log('üáµüá∞ Sticker System Initializing...');
  
  // Sticker menu toggle
  elements.stickerBtn.addEventListener('click', toggleStickerMenu);
  elements.closeStickerMenu.addEventListener('click', toggleStickerMenu);
  
  // Load stickers
  loadStickers();
  
  // Close sticker menu when clicking outside
  document.addEventListener('click', (e) => {
    if (!elements.stickerMenu.contains(e.target) && 
        e.target !== elements.stickerBtn) {
      elements.stickerMenu.style.display = 'none';
    }
  });
  
  console.log('‚úÖ Sticker System Ready');
}

function toggleStickerMenu() {
  const isVisible = elements.stickerMenu.style.display === 'flex';
  elements.stickerMenu.style.display = isVisible ? 'none' : 'flex';
  
  // Close emoji picker if open
  elements.emojiPicker.style.display = 'none';
  
  if (!isVisible) {
    // Scroll to top of sticker grid
    elements.stickerGrid.scrollTop = 0;
  }
}

function loadStickers() {
  console.log('üì¶ Loading stickers...');
  elements.stickerGrid.innerHTML = '';
  
  CONFIG.STICKERS.forEach(sticker => {
    const stickerDiv = document.createElement('div');
    stickerDiv.className = 'sticker-item';
    stickerDiv.title = sticker.name;
    
    stickerDiv.innerHTML = `
      <img src="${sticker.file}" alt="${sticker.name}" 
           onerror="this.onerror=null; this.src='data:image/svg+xml;utf8,<svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 100 100\"><rect width=\"100\" height=\"100\" fill=\"%23ff2d2d\"/><text x=\"50\" y=\"60\" font-family=\"Arial\" font-size=\"40\" fill=\"white\" text-anchor=\"middle\">${sticker.id}</text></svg>'">
    `;
    
    stickerDiv.addEventListener('click', () => {
      sendSticker(sticker.file, sticker.name);
    });
    
    elements.stickerGrid.appendChild(stickerDiv);
  });
  
  console.log(`‚úÖ Loaded ${CONFIG.STICKERS.length} stickers`);
}

function sendSticker(stickerFile, stickerName) {
  if (!currentUser.name || !currentUser.id || !app.database) {
    alert('Please wait, connecting to chat...');
    return;
  }
  
  if (!currentUser.room) {
    alert('Please join a room first!');
    return;
  }
  
  console.log(`üáµüá∞ Sending sticker to ${currentUser.room}: ${stickerName}`);
  
  const messagesRef = app.database.ref('rooms/' + currentUser.room + '/messages');
  
  messagesRef.push({
    type: 'sticker',
    stickerFile: stickerFile,
    stickerName: stickerName,
    senderId: currentUser.id,
    senderName: currentUser.name,
    timestamp: Date.now()
  }).then(() => {
    console.log('‚úÖ Sticker sent successfully');
    elements.stickerMenu.style.display = 'none';
  }).catch(error => {
    console.error('‚ùå Sticker send error:', error);
    alert('Failed to send sticker. Please try again.');
  });
}

// ========== EMOJI SYSTEM ==========
function initEmojiSystem() {
  // Emoji button click
  elements.emojiBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    const isVisible = elements.emojiPicker.style.display === 'grid';
    elements.emojiPicker.style.display = isVisible ? 'none' : 'grid';
    
    // Close sticker menu if open
    if (!isVisible) {
      elements.stickerMenu.style.display = 'none';
    }
  });
  
  // Emoji selection
  elements.emojiPicker.querySelectorAll('.emoji-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      const emoji = btn.getAttribute('data-emoji');
      elements.messageInput.value += emoji;
      elements.messageInput.focus();
      elements.emojiPicker.style.display = 'none';
    });
  });
  
  // Close emoji picker when clicking outside
  document.addEventListener('click', (e) => {
    if (!elements.emojiPicker.contains(e.target) && e.target !== elements.emojiBtn) {
      elements.emojiPicker.style.display = 'none';
    }
  });
}

// ========== SIDEBAR SYSTEM ==========
function initSidebarSystem() {
  let activeSidebar = null;
  
  // Toggle sidebar function
  function toggleSidebar(sidebar) {
    if (activeSidebar === sidebar) {
      sidebar.classList.remove('show');
      activeSidebar = null;
    } else {
      if (activeSidebar) {
        activeSidebar.classList.remove('show');
      }
      sidebar.classList.add('show');
      activeSidebar = sidebar;
    }
    
    // Close sticker menu if open
    elements.stickerMenu.style.display = 'none';
    elements.emojiPicker.style.display = 'none';
  }
  
  // Button events
  elements.menuBtn.addEventListener('click', () => toggleSidebar(elements.sidebar));
  elements.onlineBtn.addEventListener('click', () => toggleSidebar(elements.onlineSidebar));
  
  // Close sidebar when clicking outside
  document.addEventListener('click', (e) => {
    if (activeSidebar && 
        !activeSidebar.contains(e.target) && 
        e.target !== elements.menuBtn && 
        e.target !== elements.onlineBtn) {
      activeSidebar.classList.remove('show');
      activeSidebar = null;
    }
  });
}

// ========== SECRET PANEL ==========
function initSecretPanel() {
  elements.secretBtn.addEventListener('click', () => {
    const isVisible = elements.secretContainer.style.display === 'block';
    elements.secretContainer.style.display = isVisible ? 'none' : 'block';
    
    if (!isVisible) {
      // Show passwords
      document.getElementById('secretPass1').textContent = CONFIG.SECRET_PASSWORDS.Chatroom1;
      document.getElementById('secretPass2').textContent = CONFIG.SECRET_PASSWORDS.Chatroom2;
      document.getElementById('secretPass3').textContent = CONFIG.SECRET_PASSWORDS.Chatroom3;
      document.getElementById('secretPass4').textContent = CONFIG.SECRET_PASSWORDS.Chatroom4;
      document.getElementById('secretPass5').textContent = CONFIG.SECRET_PASSWORDS.Chatroom5;
    }
  });
  
  // Close when clicking outside
  document.addEventListener('click', (e) => {
    if (!elements.secretContainer.contains(e.target) && e.target !== elements.secretBtn) {
      elements.secretContainer.style.display = 'none';
    }
  });
}

function hideSecretPanel() {
  elements.secretContainer.style.display = 'none';
}

// ========== ROOM MANAGEMENT ==========
function initRoomSystem() {
  elements.chatrooms.forEach(room => {
    room.addEventListener('click', () => {
      const roomName = room.getAttribute('data-room');
      const password = room.getAttribute('data-password');
      const bgFile = room.getAttribute('data-bg');
      
      if (roomName === currentUser.room) {
        elements.sidebar.classList.remove('show');
        return;
      }
      
      if (password) {
        showPasswordModal(roomName, password, bgFile);
      } else {
        switchRoom(roomName, bgFile);
      }
    });
  });
}

function showPasswordModal(roomName, requiredPassword, bgFile) {
  elements.roomPrompt.textContent = `Enter password for "${roomName}":`;
  elements.passwordModal.style.display = 'flex';
  elements.passwordInput.focus();
  elements.passwordInput.value = '';
  
  // Store room data in modal
  elements.passwordModal.dataset.room = roomName;
  elements.passwordModal.dataset.password = requiredPassword;
  elements.passwordModal.dataset.bg = bgFile;
}

function switchRoom(roomName, bgFile) {
  console.log(`üö™ Switching to room: ${roomName}`);
  
  // IMPORTANT: Remove previous room listener
  if (app.currentMessageListener && app.database) {
    app.currentMessageListener.off(); // Detach previous listener
    app.currentMessageListener = null;
  }
  
  // Clear current messages
  elements.messages.innerHTML = '<div class="loading">Loading messages...</div>';
  
  // Update user state
  currentUser.room = roomName;
  elements.roomNameDisplay.textContent = roomName;
  
  // Update active room UI
  elements.chatrooms.forEach(room => {
    room.classList.remove('active');
    if (room.getAttribute('data-room') === roomName) {
      room.classList.add('active');
    }
  });
  
  // Change background
  if (bgFile) {
    document.getElementById('animeBg').style.backgroundImage = `url('${bgFile}')`;
  }
  
  // Load messages for new room
  loadMessages();
  
  // Close sidebar
  elements.sidebar.classList.remove('show');
  
  // Update online status with new room
  if (currentUser.id) {
    updateOnlineStatus();
  }
  
  // Show welcome message
  setTimeout(() => {
    showSystemMessage(`Welcome to ${roomName}! Start chatting now.`);
  }, 500);
}

// ========== MESSAGE SYSTEM ==========
function initMessageSystem() {
  // Send message
  elements.sendButton.addEventListener('click', sendMessage);
  elements.messageInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });
  
  // Typing indicator
  let typingTimeout;
  elements.messageInput.addEventListener('input', () => {
    if (!currentUser.id) return;
    
    // Update typing status
    if (app.database) {
      app.database.ref('typing/' + currentUser.id).set({
        name: currentUser.name,
        typing: true,
        timestamp: Date.now(),
        room: currentUser.room
      });
      
      // Clear previous timeout
      if (typingTimeout) clearTimeout(typingTimeout);
      
      // Set timeout to stop typing indicator
      typingTimeout = setTimeout(() => {
        app.database.ref('typing/' + currentUser.id).set({
          name: currentUser.name,
          typing: false,
          timestamp: Date.now(),
          room: currentUser.room
        });
      }, 2000);
    }
  });
}

function sendMessage() {
  const text = elements.messageInput.value.trim();
  if (!text) {
    return;
  }
  
  if (!currentUser.name || !currentUser.id) {
    alert('Please enter your name first!');
    return;
  }
  
  if (!app.database) {
    alert('Database not connected yet. Please wait...');
    return;
  }
  
  if (!currentUser.room) {
    alert('Please select a room first!');
    return;
  }
  
  console.log(`üí¨ Sending message to ${currentUser.room}: ${text.substring(0, 20)}...`);
  
  const messagesRef = app.database.ref('rooms/' + currentUser.room + '/messages');
  
  messagesRef.push({
    text: text,
    senderId: currentUser.id,
    senderName: currentUser.name,
    timestamp: Date.now(),
    type: 'text'
  }).then(() => {
    elements.messageInput.value = '';
    elements.messageInput.focus();
    
    // Stop typing indicator
    if (app.database) {
      app.database.ref('typing/' + currentUser.id).set({
        name: currentUser.name,
        typing: false,
        timestamp: Date.now(),
        room: currentUser.room
      });
    }
  }).catch(error => {
    console.error('‚ùå Send error:', error);
    alert('Failed to send message. Please try again.');
  });
}

function loadMessages() {
  console.log(`üì® Loading messages for room: ${currentUser.room}`);
  elements.loading.style.display = 'block';
  elements.messages.innerHTML = '';
  
  if (!app.database) {
    showSystemMessage('Connecting to database...');
    elements.loading.style.display = 'none';
    return;
  }
  
  const messagesRef = app.database.ref('rooms/' + currentUser.room + '/messages');
  
  // Remove previous listener if exists
  if (app.currentMessageListener) {
    app.currentMessageListener.off();
  }
  
  // Store the listener reference
  app.currentMessageListener = messagesRef.orderByChild('timestamp').limitToLast(100);
  
  app.currentMessageListener.on('value', (snapshot) => {
    elements.loading.style.display = 'none';
    elements.messages.innerHTML = '';
    
    if (!snapshot.exists()) {
      showSystemMessage(`Welcome to ${currentUser.room}! Be the first to send a message.`);
      return;
    }
    
    const messages = [];
    snapshot.forEach(child => {
      messages.push({
        id: child.key,
        ...child.val()
      });
    });
    
    // Sort by timestamp (oldest first)
    messages.sort((a, b) => a.timestamp - b.timestamp);
    
    // Display messages
    messages.forEach(msg => {
      addMessageToUI(msg);
    });
    
    // Scroll to bottom
    setTimeout(() => {
      elements.chatContainer.scrollTop = elements.chatContainer.scrollHeight;
    }, 100);
    
  }, (error) => {
    console.error('‚ùå Load messages error:', error);
    elements.loading.style.display = 'none';
    showSystemMessage('Error loading messages. Please refresh.');
  });
}

function addMessageToUI(message) {
  const isSentByMe = message.senderId === currentUser.id;
  const messageDiv = document.createElement('div');
  messageDiv.className = `message ${isSentByMe ? 'sent' : 'received'}`;
  messageDiv.id = `msg-${message.id}`;
  
  const time = new Date(message.timestamp).toLocaleTimeString([], { 
    hour: '2-digit', minute: '2-digit' 
  });
  
  // Check if message is sticker
  let content = '';
  if (message.type === 'sticker') {
    content = `
      <div style="text-align:center;padding:5px;">
        <img src="${message.stickerFile}" alt="${message.stickerName}" 
             style="max-width:120px;max-height:120px;border-radius:10px;border:2px solid rgba(255,255,255,0.1);"
             onerror="this.onerror=null; this.style.display='none'; this.parentElement.innerHTML='<div style=\'color:#ff2d2d;padding:10px;\'>üáµüá∞ ${message.stickerName}</div>';">
        <div style="font-size:11px;opacity:0.7;margin-top:5px;background:rgba(255,255,255,0.05);padding:3px 8px;border-radius:10px;">${message.stickerName}</div>
      </div>
    `;
  } else {
    content = message.text || '';
  }
  
  // Action buttons only for own messages
  let actionButtons = '';
  if (isSentByMe) {
    actionButtons = `
      <div class="message-actions">
        <button class="message-action-btn" onclick="forwardMessage('${message.id}')" title="Forward">‚Ü™Ô∏è</button>
        <button class="message-action-btn" onclick="deleteMessage('${message.id}')" title="Delete">üóëÔ∏è</button>
      </div>
    `;
  }
  
  messageDiv.innerHTML = `
    <div class="sender-name">
      <span>${message.senderName || 'Unknown'} ${isSentByMe ? '(You)' : ''}</span>
      <span class="message-time">${time}</span>
    </div>
    ${content}
    ${actionButtons}
  `;
  
  // Show actions on hover for own messages
  if (isSentByMe && message.type !== 'sticker') {
    const actionsDiv = messageDiv.querySelector('.message-actions');
    if (actionsDiv) {
      messageDiv.addEventListener('mouseenter', () => {
        actionsDiv.style.display = 'flex';
      });
      messageDiv.addEventListener('mouseleave', () => {
        actionsDiv.style.display = 'none';
      });
    }
  }
  
  elements.messages.appendChild(messageDiv);
}

function showSystemMessage(text) {
  const messageDiv = document.createElement('div');
  messageDiv.className = 'message received';
  messageDiv.style.background = 'rgba(255, 45, 45, 0.1)';
  messageDiv.style.border = '1px dashed rgba(255, 45, 45, 0.3)';
  messageDiv.innerHTML = `
    <div class="sender-name">
      <span style="color:#ff2d2d;">i see u don't spam üôÑ</span>
      <span class="message-time">${new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</span>
    </div>
    ${text}
  `;
  elements.messages.appendChild(messageDiv);
}

// ========== FORWARD AND DELETE ==========
function forwardMessage(messageId) {
  if (!app.database) return;
  
  const messageRef = app.database.ref('rooms/' + currentUser.room + '/messages/' + messageId);
  messageRef.once('value').then(snapshot => {
    const message = snapshot.val();
    if (message && message.text) {
      elements.messageInput.value = `FWD: ${message.text}`;
      elements.messageInput.focus();
    }
  });
}

function deleteMessage(messageId) {
  if (!app.database) return;
  
  if (confirm('Are you sure you want to delete this message?')) {
    app.database.ref('rooms/' + currentUser.room + '/messages/' + messageId).remove()
      .then(() => {
        console.log('‚úÖ Message deleted');
      })
      .catch(error => {
        console.error('‚ùå Delete error:', error);
        alert('Failed to delete message');
      });
  }
}

// ========== ONLINE STATUS SYSTEM ==========
function updateOnlineStatus() {
  if (!currentUser.id || !currentUser.name || !app.database) return;
  
  const userStatusRef = app.database.ref('status/' + currentUser.id);
  
  // Set online status
  userStatusRef.set({
    name: currentUser.name,
    online: true,
    lastSeen: Date.now(),
    room: currentUser.room,
    userId: currentUser.id
  });
  
  // Set offline on disconnect
  userStatusRef.onDisconnect().update({
    online: false,
    lastSeen: Date.now()
  });
  
  // Listen for other users
  app.database.ref('status').on('value', (snapshot) => {
    const users = [];
    let onlineCount = 0;
    
    if (snapshot.exists()) {
      snapshot.forEach(child => {
        const user = child.val();
        if (user.online) {
          users.push(user);
          onlineCount++;
        }
      });
    }
    
    // Update UI (remove current user from count)
    const otherUsersCount = Math.max(0, onlineCount - 1);
    elements.onlineBadge.textContent = otherUsersCount;
    elements.onlineCount.textContent = otherUsersCount + ' online';
    
    // Update online users list (excluding current user)
    const otherUsers = users.filter(user => user.userId !== currentUser.id);
    if (otherUsers.length === 0) {
      elements.onlineUsersList.innerHTML = '<div class="loading">No other users online</div>';
    } else {
      let html = '';
      otherUsers.forEach(user => {
        html += `
          <div class="online-user">
            <div class="user-avatar">${user.name.charAt(0).toUpperCase()}</div>
            <div>
              <strong>${user.name}</strong><br>
              <small>In: ${user.room || 'general'}</small>
            </div>
          </div>
        `;
      });
      elements.onlineUsersList.innerHTML = html;
    }
  });
}

// ========== FIREBASE INITIALIZATION ==========
function initializeFirebase() {
  return new Promise((resolve, reject) => {
    // Check if Firebase is already loaded
    if (typeof firebase === 'undefined') {
      console.log('üî• Loading Firebase...');
      // Load Firebase dynamically
      const script = document.createElement('script');
      script.src = 'https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js';
      script.onload = () => {
        const authScript = document.createElement('script');
        authScript.src = 'https://www.gstatic.com/firebasejs/8.6.8/firebase-auth.js';
        authScript.onload = () => {
          const dbScript = document.createElement('script');
          dbScript.src = 'https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js';
          dbScript.onload = () => {
            initFirebaseApp();
            resolve();
          };
          document.head.appendChild(dbScript);
        };
        document.head.appendChild(authScript);
      };
      script.onerror = reject;
      document.head.appendChild(script);
    } else {
      initFirebaseApp();
      resolve();
    }
  });
  
  function initFirebaseApp() {
    try {
      app.firebase = firebase.initializeApp(CONFIG.FIREBASE_CONFIG);
      app.database = firebase.database();
      app.auth = firebase.auth();
      console.log('‚úÖ Firebase initialized successfully');
    } catch (error) {
      console.error('‚ùå Firebase initialization error:', error);
    }
  }
}

// ========== USER INITIALIZATION ==========
function initializeUser() {
  if (!app.auth) {
    console.error('‚ùå Firebase auth not available');
    return;
  }
  
  console.log('üë§ Signing in user...');
  
  app.auth.signInAnonymously()
    .then((userCredential) => {
      currentUser.id = userCredential.user.uid;
      console.log('‚úÖ User signed in:', currentUser.name, currentUser.id);
      
      // Start app features
      updateOnlineStatus();
      loadMessages();
      
      // Focus input
      setTimeout(() => {
        elements.messageInput.focus();
        showSystemMessage(`Welcome ${currentUser.name}! You joined ${currentUser.room}. Send messages or stickers!`);
      }, 1000);
      
    }).catch(error => {
      console.error('‚ùå Sign in error:', error);
      showSystemMessage('Connection error. Please refresh.');
    });
}

// ========== EVENT LISTENERS ==========
function initEventListeners() {
  // Name submission
  document.getElementById('submitName').addEventListener('click', () => {
    currentUser.name = elements.nameInput.value.trim() || 'AnimeFan' + Math.floor(Math.random() * 1000);
    if (currentUser.name) {
      localStorage.setItem('animechat_username', currentUser.name);
      elements.nameModal.style.display = 'none';
      document.title = currentUser.name + ' - AnimeChat Pro';
      initializeUser();
    }
  });
  
  elements.nameInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      document.getElementById('submitName').click();
    }
  });
  
  // Password submission
  document.getElementById('submitPassword').addEventListener('click', () => {
    const roomName = elements.passwordModal.dataset.room;
    const requiredPassword = elements.passwordModal.dataset.password;
    const bgFile = elements.passwordModal.dataset.bg;
    const enteredPassword = elements.passwordInput.value.trim().toUpperCase();
    
    if (enteredPassword === requiredPassword) {
      switchRoom(roomName, bgFile);
      elements.passwordModal.style.display = 'none';
      elements.passwordInput.value = '';
    } else {
      alert('‚ùå Wrong password! Try again.');
      elements.passwordInput.focus();
      elements.passwordInput.select();
    }
  });
  
  document.getElementById('cancelPassword').addEventListener('click', () => {
    elements.passwordModal.style.display = 'none';
    elements.passwordInput.value = '';
  });
  
  elements.passwordInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      document.getElementById('submitPassword').click();
    }
  });
  
  // Navigation
  elements.navItems.forEach(item => {
    item.addEventListener('click', () => {
      const tab = item.getAttribute('data-tab');
      
      elements.navItems.forEach(nav => nav.classList.remove('active'));
      item.classList.add('active');
      
      switch(tab) {
        case 'rooms':
          elements.sidebar.classList.add('show');
          break;
        case 'online':
          elements.onlineSidebar.classList.add('show');
          break;
        case 'theme':
          // Cycle through backgrounds
          const bgFiles = ['background.png', 'bg1.png', 'bg2.png', 'bg3.png', 'bg4.png', 'bg5.png'];
          const currentBg = document.getElementById('animeBg').style.backgroundImage;
          let currentIndex = 0;
          
          for (let i = 0; i < bgFiles.length; i++) {
            if (currentBg.includes(bgFiles[i])) {
              currentIndex = i;
              break;
            }
          }
          
          const nextIndex = (currentIndex + 1) % bgFiles.length;
          document.getElementById('animeBg').style.backgroundImage = `url('${bgFiles[nextIndex]}')`;
          showSystemMessage(`Theme changed to Background ${nextIndex + 1}`);
          break;
      }
    });
  });
  
  // Auto-adjust chat container height
  function adjustChatHeight() {
    const headerHeight = document.querySelector('.chat-header').offsetHeight;
    const inputHeight = document.querySelector('.input-area').offsetHeight;
    const navHeight = document.querySelector('.nav-bar').offsetHeight;
    
    elements.chatContainer.style.height = `calc(100vh - ${headerHeight + inputHeight + navHeight}px)`;
  }
  
  adjustChatHeight();
  window.addEventListener('resize', adjustChatHeight);
}

// ========== APP INITIALIZATION ==========
async function initializeApp() {
  console.log('üöÄ AnimeChat Pro - ZAFAR Rooms LOADED');
  console.log('üáµüá∞ Sticker Pack: 10 FREE Anime Stickers');
  
  // Initialize UI systems
  initStickerSystem();
  initEmojiSystem();
  initSidebarSystem();
  initSecretPanel();
  initRoomSystem();
  initMessageSystem();
  initEventListeners();
  
  // Check for saved user
  if (currentUser.name) {
    console.log('‚úÖ Found saved user:', currentUser.name);
    document.title = currentUser.name + ' - AnimeChat Pro';
    
    // Initialize Firebase and then user
    try {
      await initializeFirebase();
      initializeUser();
    } catch (error) {
      console.error('‚ùå App initialization failed:', error);
      showSystemMessage('Failed to connect. Please refresh the page.');
    }
  } else {
    console.log('üÜï No saved user - showing modal');
    elements.nameModal.style.display = 'flex';
    elements.nameInput.focus();
    elements.nameInput.value = 'AnimeFan' + Math.floor(Math.random() * 1000);
  }
}

// ========== START APP ==========
document.addEventListener('DOMContentLoaded', initializeApp);

// Export functions for global access
window.forwardMessage = forwardMessage;
window.deleteMessage = deleteMessage;
window.hideSecretPanel = hideSecretPanel;
</script>